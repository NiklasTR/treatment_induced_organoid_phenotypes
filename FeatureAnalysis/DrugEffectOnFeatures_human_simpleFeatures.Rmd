# Analysis of image features

Image features, e.g. haralick texture features, potentially contains rich biological information. This vignette attempts to determine the effects drugs have on organoids, when compared to the DMSO control, for a given cell line.

This vignette concerns the mouse organoids.

```{r message=FALSE, warning=FALSE, include=FALSE}
# Install and load libraries
library(PROMISE)
library(ggplot2)
library(data.table)
library(rhdf5)

# Directories and files
feature_dir = "/Users/jansauer/Thesis/Projects/PROMISE/FeatureAnalysis/features"
source(file.path(dirname(feature_dir), "SelectFeaturesMedian.R"))
config_dir = "/collab-ag-fischer/PROMISE/data-10x-4t-c-16z/configdir"
# config_dir = "/Users/jansauer/tmp/watchdog_local/configdir"
source(file.path(config_dir, "watchdogConfig.R"))
blurrywells = "/Users/jansauer/Thesis/Projects/PROMISE/FilterBlurryWells/mouse/blurry_wells_predicted.txt"

# Parameters
feature_type = "organoids"
```

## Averaged organoid features

Due to the sheer amount of features, a first attempt is made at an analysis with the averaged features for each organoid in wells. Both the median and the median absolute deviation (mad) of the features for each organoid in a well are used. In addition, I averaged the values of large and small objects separately. Proper organoids most likely have an area of at least 5000 pixels, so all objects larger than this were grouped together. All objects smaller than 5000 pixels in area were also grouped and considered to be either individual cells or fragments of organoids. These two sets of summary features were concatenated for each well so that for each well, the feature set looks like:

    [organoids_feature1_median, ... , organoids_featureN_median, organoids_feature1_mad, ... , organoids_featureN_mad, 
     fragments_feature1_median, ... , fragments_featureN_median, fragments_feature1_mad, ... , fragments_featureN_mad]

## Simple Analysis

A first, simple analysis attempts to differentiate positive from negative controls. For this, I load all data for cell lines and extract the positive ("Staurosporine_500nM") and negative ("DMSO") wells.

```{r load_data}
all_cell_lines = unique(substr(list.files(feature_dir, pattern = "D0"), 1, 7))

# D010 has some older plates with library L01 but these are very low quality 
# and shouldn't be included here as they contain drugs not used for any other cell line
permitted_libraries = c("L02", "L03", "L08")

features = lapply(all_cell_lines, function(cell_line) {
  feat = get_median_features(
    cell_line = cell_line, featuredir = feature_dir, 
    configdir = config_dir, feature_type = feature_type)
  lib = substr(rownames(feat), 12, 14)
  feat = feat[lib %in% permitted_libraries,]
  pos_ctrl = feat[grep("Staurosporine_500nM", feat$DRUG, ignore.case = TRUE),]
  neg_ctrl = feat[grep("DMSO", feat$DRUG, ignore.case = TRUE),]
  dat = rbind(pos_ctrl, neg_ctrl)
  return(dat)})

# well info
cell_line_info = rep(all_cell_lines, times = sapply(features, nrow))
well_name_info = do.call(c, lapply(features, rownames))

features = data.frame(rbindlist(features, use.names = TRUE, fill = TRUE))
rownames(features) = well_name_info
```

The most immediately interesting biological features are the number of organoids as well as their average size and the total area. The first two features I extract only from the "signal" elements, leaving out any erroneously segmented single cells or other segmented elements too small to be proper organoids. The total area I extract from both signal and noise. I'm interested in both the medians and the MADs

### Number of Organoids per Well

For easier interpretability, it makes more sense to look at the unnormalized values for the number of organoids
```{r}
inv_glog = function(y, c=0.05) {
  return(0.25 * exp(-y) * (4*exp(2*y) - c**2))
}

sf_numobj = features[,"signal_num.of.objects"]
sf_numobj_noise = features[,"noise_num.of.objects"]
sf_drug = features[,"DRUG"]
simple_features = data.frame(
  "Num.Objects" = inv_glog(sf_numobj),
  "Num.Objects.Noise" = inv_glog(sf_numobj_noise),
  "Drug" = sf_drug,
  "Cell.Line" = substr(rownames(features), 1, 4)
)
```

Note that the filtering between what is and what isn't an organoid is rudimentary at this point. I've simply used a size threshold, i.e. anything with an area < 2500 pixels (corresponding to a radius of approx. 30 pixels for a circular object) is most likely not an organoid and counted as shrapnel. Shrapnel could be individual cells or badly/partially segmented organoids. As the segmentation algorithm was not explicitly trained to recognize individual cells, there is absolutely no guarantee that these are reliably detected. A better detection method for individual cells would be to look at the intensity distribution across an image and compare it with the organoid segmentation to find any "hotspots" not detected by the segmentation.

All cell lines show a clear trend for DMSO wells having more organoids than the Staurosporine controls. Some cell lines (D013, D019, and D030 in particular) also show that the Staurosporine wells have far more "shrapnel", i.e. individual cells or partially destroyed organoids.

```{r}
ggplot(data = simple_features) + geom_boxplot(aes(x = Cell.Line, y = Num.Objects, fill = Drug)) + 
  ggtitle(label = "Number of Organoids per Well") + xlab("Cell Line") + ylab("Number of Organoids")
```

```{r}
ggplot(data = simple_features) + geom_boxplot(aes(x = Cell.Line, y = Num.Objects.Noise, fill = Drug)) + 
  ggtitle(label = "Number of 'Shrapnel' Objects per Well", 
          subtitle = "'Shrapnel' is defined as objects too small to be proper organoids") + 
  xlab("Cell Line") + ylab("Number of Objects")
```

### Mean Area of Organoids per Well

The area scales quadratically and the resulting large range of potential values makes it more reasonable to look at the log-normalized values here.

```{r}
glog = function(x, c=0.05) {
  return(log((x + sqrt(x**2 + c**2)) / 2))
}

inv_glog = function(y, c=0.05) {
  return(0.25 * exp(-y) * (4*exp(2*y) - c**2))
}

sf_area_median = features[,"signal_x.0.s.area_median"]
sf_area_median_noise = features[,"noise_x.0.s.area_median"]
sf_area_mad = features[,"signal_x.0.s.area_mad"]
sf_numobj = features[,"signal_num.of.objects"]
sf_numobj_noise = features[,"noise_num.of.objects"]
sf_drug = features[,"DRUG"]

total_area = (inv_glog(sf_numobj) * inv_glog(sf_area_median)) + 
  (inv_glog(sf_numobj_noise) * inv_glog(sf_area_median_noise))
total_num_objects = inv_glog(sf_numobj) + inv_glog(sf_numobj_noise)

simple_features = data.frame(
  "Area.mean" = sf_area_median, 
  "Area.sd" = sf_area_mad,
  "Total.Area" = glog(total_area),
  "Total.Area.mean" = glog(total_area / total_num_objects),
  "Drug" = sf_drug,
  "Cell.Line" = substr(rownames(features), 1, 4)
)
```

```{r}
ggplot(data = simple_features) + geom_boxplot(aes(x = Cell.Line, y = Area.mean, fill = Drug)) + 
  ggtitle(label = "Mean Area of Organoids per Well") + xlab("Cell Line") + ylab("Mean Area")
```

```{r}
ggplot(data = simple_features) + geom_boxplot(aes(x = Cell.Line, y = Area.sd, fill = Drug)) + 
  ggtitle(label = "Standard Deviation of Area of Organoids per Well") + xlab("Cell Line") + ylab("Std. Dev. of Area")
```

### Total Area

This result should be appreciated with caution as the segmentation algorithm was not specifically designed to detect shrapnel and individual cells. Nevertheless, a trend towards less biomatter in the positive controls is clear (for most cell lines). A look at the relative intensity distributions can potentially support this result.

```{r}
ggplot(data = simple_features) + geom_boxplot(aes(x = Cell.Line, y = Total.Area, fill = Drug)) + 
  ggtitle(label = "Total Covered Area per Well") + xlab("Cell Line") + ylab("Total Area")
```

<!-- ## Intensity Distribution -->

<!-- The intensity distributions between the positive and negative controls will hopefully give some more insight into the differences between the organoids. -->

<!-- ```{r int_distr, cache=TRUE} -->
<!-- # This file is saved because extracting this info takes a LONG time. -->
<!-- if(file.exists("intensity_distributions_pos_neg.rds")) { -->
<!--   total_int_distr = readRDS("intensity_distributions_pos_neg.rds") -->
<!-- } else { -->
<!--   total_int_distr = setNames( -->
<!--     object = vector(mode = "list", length = length(all_cell_lines)),  -->
<!--     nm = all_cell_lines) -->
<!--   for(cell_line in all_cell_lines) { -->
<!--     cl_feat = features[cell_line_info == cell_line,] -->

<!--     # Positive controls -->
<!--     pos_ctrl = cl_feat[cl_feat$DRUG == "Staurosporine_500nM",] -->
<!--     plate = substr(rownames(pos_ctrl), 1, 14) -->
<!--     row = substr(rownames(pos_ctrl), 16, 16) -->
<!--     col = substr(rownames(pos_ctrl), 17, 18) -->
<!--     well_ids = data.frame(plate, row, col) -->
<!--     pos_int_distr = array(0L, dim = c(65536, 3, 4, nrow(well_ids))) -->
<!--     for(i in seq_len(nrow(well_ids))) { -->
<!--       pos_int_distr[,,,i] = h5read(paste0( -->
<!--         "/collab-ag-fischer/PROMISE/data-10x-4t-c-16z/features/intensity_distribution/", -->
<!--         well_ids[i, "plate"],  -->
<!--         sprintf("/%s_%s_%s_intensity_distribution.h5",  -->
<!--                 well_ids[i, "plate"], well_ids[i, "row"], well_ids[i, "col"])),  -->
<!--         "features")[,,,1] -->
<!--     } -->

<!--     # Bin into histograms -->
<!--     n_bins = 256 -->
<!--     hist_indices = rep(as.character(1:n_bins), times = rep(65536/n_bins, n_bins)) -->
<!--     dimnames(pos_int_distr) = list( -->
<!--       "Value" = hist_indices,  -->
<!--       "Channel" = seq_len(dim(pos_int_distr)[2]), -->
<!--       "Field" = seq_len(dim(pos_int_distr)[3]), -->
<!--       "Num.Wells" = seq_len(dim(pos_int_distr)[4]) -->
<!--     ) -->
<!--     pos_int_distr_binned = reshape2::acast( -->
<!--       melt(pos_int_distr), Value ~ Channel ~ Field ~ Num.Wells, fun.aggregate = sum) -->
<!--     pos_int_distr_mean = apply(pos_int_distr_binned, c(1, 2), mean) -->
<!--     pos_int_distr_sd = apply(pos_int_distr_binned, c(1, 2), sd) -->

<!--     # Negative controls -->
<!--     neg_ctrl = cl_feat[cl_feat$DRUG == "DMSO",] -->
<!--     plate = substr(rownames(neg_ctrl), 1, 14) -->
<!--     row = substr(rownames(neg_ctrl), 16, 16) -->
<!--     col = substr(rownames(neg_ctrl), 17, 18) -->
<!--     well_ids = data.frame(plate, row, col) -->
<!--     neg_int_distr = array(0L, dim = c(65536, 3, 4, nrow(well_ids))) -->
<!--     for(i in seq_len(nrow(well_ids))) { -->
<!--       neg_int_distr[,,,i] = h5read(paste0( -->
<!--         "/collab-ag-fischer/PROMISE/data-10x-4t-c-16z/features/intensity_distribution/", -->
<!--         well_ids[i, "plate"],  -->
<!--         sprintf("/%s_%s_%s_intensity_distribution.h5",  -->
<!--                 well_ids[i, "plate"], well_ids[i, "row"], well_ids[i, "col"])),  -->
<!--         "features")[,,,1] -->
<!--     } -->

<!--     # Bin into histograms -->
<!--     n_bins = 256 -->
<!--     hist_indices = rep(as.character(1:n_bins), times = rep(65536/n_bins, n_bins)) -->
<!--     dimnames(neg_int_distr) = list( -->
<!--       "Value" = hist_indices,  -->
<!--       "Channel" = seq_len(dim(neg_int_distr)[2]), -->
<!--       "Field" = seq_len(dim(neg_int_distr)[3]), -->
<!--       "Num.Wells" = seq_len(dim(neg_int_distr)[4]) -->
<!--     ) -->
<!--     neg_int_distr_binned = reshape2::acast( -->
<!--       melt(neg_int_distr), Value ~ Channel ~ Field ~ Num.Wells, fun.aggregate = sum) -->

<!--     neg_int_distr_mean = apply(neg_int_distr_binned, c(1, 2), mean) -->
<!--     neg_int_distr_sd = apply(neg_int_distr_binned, c(1, 2), sd) -->

<!--     total_int_distr[[cell_line]] = list( -->
<!--       "pos_ctrl" = pos_int_distr_binned, "neg_ctrl" = neg_int_distr_binned,  -->
<!--       "pos_ctrl_mean" = pos_int_distr_mean, "neg_ctrl_mean" = neg_int_distr_mean,  -->
<!--       "pos_ctrl_sd" = pos_int_distr_sd, "neg_ctrl_sd" = neg_int_distr_sd) -->
<!--   } -->
<!--   saveRDS(total_int_distr, "intensity_distributions_pos_neg.rds") -->
<!-- } -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ggplotdf_ratio = melt(data.frame( -->
<!--   "Intensity.Bin" = seq_len(nrow(total_int_distr$D004T01$pos_ctrl_mean)), -->
<!--   "Cy3" = total_int_distr$D004T01$pos_ctrl_mean[,1] / total_int_distr$D004T01$neg_ctrl_mean[,1],  -->
<!--   "FITC" = total_int_distr$D004T01$pos_ctrl_mean[,2] / total_int_distr$D004T01$neg_ctrl_mean[,2],  -->
<!--   "DAPI" = total_int_distr$D004T01$pos_ctrl_mean[,3] / total_int_distr$D004T01$neg_ctrl_mean[,3]),  -->
<!--   id = "Intensity.Bin") -->
<!-- ggplot(data = ggplotdf_ratio) + geom_point(aes(x = Intensity.Bin, y = value, color = variable)) -->
<!-- ``` -->