---
title: "Organoid Pseudotime"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

# Setup

```{r}
library(tidyverse)
library(here)
library(feather)
library(monocle3)
library(ggrastr)

# install.packages('devtools')
# devtools::install_github('VPetukhov/ggrastr')
```

I load the dataset in question. 

```{r, eval = FALSE}
pca_raw <- feather::read_feather(path = here("data/embeddings/hdf_pca_feather"))
#pca_raw <- pca_raw_store
```

I give a short overview of the dataset. 

```{r, eval = FALSE}
pca_raw %>% 
  sample_n(10000) %>%
  ggplot(aes(V1, V2, color = morphological_class)) + 
  geom_point() + 
  theme_classic() + 
  scale_color_viridis_d()
  
```


```{r, eval = FALSE}
# for demo: subsample the original dataset
set.seed(123)

pca_raw_store <- pca_raw
pca_raw <- pca_raw %>% 
  sample_n(100000)
```


# Import into Monocle 3

I continue importing the dataset into Monoocle3 

```{r, eval = FALSE}
# generating metadata objects
pca_anno_df <- pca_raw %>% dplyr::select(-(V1:V25)) %>% 
  mutate(uuid = paste(Plate, Well, Field, ObjectID, sep = "_")) %>% 
  mutate(uuid2 = uuid) %>% 
  mutate(Size = as.numeric(Size)) %>%
  mutate(Size_log = log(Size)) %>%
  as.data.frame() %>% 
  column_to_rownames("uuid2")

pca_matrix <- pca_raw %>% dplyr::select((V1:V25)) %>% as.data.frame() %>% magrittr::set_rownames(pca_anno_df$uuid) %>% magrittr::set_colnames(c(paste0("PC", c(1:25)))) %>% as.matrix()


ods <- new_cell_data_set(pca_matrix %>% t(),
                         cell_metadata = pca_anno_df)
```

I manually inject the PCA compression of the data into the object

```{r, eval = FALSE}
reducedDims(ods)$PCA <- pca_matrix
```

I run the dim reduction methods

```{r, eval = FALSE}
set.seed(123)
ods <- reduce_dimension(ods,
                        reduction_method = "UMAP",
                        umap.n_neighbors = 15L,
                        umap.fast_sgd=TRUE, 
                        cores = parallel::detectCores(),
                        verbose = TRUE)

saveRDS(ods, here("data/monocle/bulk_pca_cluster.Rds"))
```

I load the UMAP embedding of the organoid dataset. 

```{r}
ods <- readRDS(here("data/monocle/bulk_pca_cluster.Rds"))
```


I plot the cells by size

```{r, eval = FALSE}
gg_size <- plot_cells(ods, color_cells_by="Size", 
           alpha = 0.1,
           rasterize= TRUE) + 
  scale_color_viridis_c() + 
  theme(legend.position = "bottom")

# gg_size + 
#   ggsave("size.pdf", height = 4, width = 4)

gg_size %>% saveRDS(here("data/ggplot/gg_size.Rds"))
```

I use an alterantive, manual, plotting method. 

```{r}
set.seed(123)

df <- reducedDims(ods)$UMAP %>% cbind(colData(ods)) %>% as_tibble() %>%
  sample_frac(1)

gg_size <- df %>%
  ggplot(aes(v1, v2, color = Size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom") +
  theme(axis.title.x = element_text(color = "black", size = 8),
        axis.title.y = element_text(color = "black", size = 8),
        axis.text.y = element_text(color = "black", size = 8),
        axis.text.x = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8),
        legend.title = element_text(color = "black", size = 8))

gg_size %>% saveRDS(here("data/ggplot/gg_size.Rds"))
```


I create a single plot showing the two extreme organoid lines and their distribution within the embedding. 

```{r}
set.seed(123)

df <- reducedDims(ods)$UMAP %>% cbind(colData(ods)) %>% as_tibble() %>%
  filter(Drug == "DMSO") %>% 
  sample_frac(1)

gg_line <- df %>%
  ggplot(aes(V1, V2)) + 
  geom_point_rast(alpha = 1, size = 0.35, color = "#f1f1f1") + 
  geom_point_rast(data = df %>%
    filter(Line %in% c("D055T01", "D030T01")),
  aes(color = Line),alpha = .2, size = 0.35, shape=16) + 
  #facet_wrap(morphological_class ~ Line) + 
  scale_color_manual(values = rev(c("#D80D12", "#A9CEE1"))) + 
  #geom_density2d(color = "black") + 
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
       #caption = "control treated organoids") + 
  theme(legend.position = "bottom") +
  theme(axis.title.x = element_text(color = "black", size = 8),
        axis.title.y = element_text(color = "black", size = 8),
        axis.text.y = element_text(color = "black", size = 8),
        axis.text.x = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8),
        legend.title = element_text(color = "black", size = 8))

gg_line %>% saveRDS(here("data/ggplot/gg_line.Rds"))
```



```{r}
gg_line_overview <- plot_cells(ods, color_cells_by="morphological_class",
           alpha = 0.05, label_cell_groups = FALSE,
           rasterize = TRUE) + 
  facet_wrap(~ Line) + 
  theme(legend.position = "nothing") + 
  scale_color_manual(values = rev(c("#A2549B", "#D80D12", "#6E1614","#69B563", "#A9CEE1","#1E3B87"))) 
```

I directly write this supplementary plot to disc. 

```{r, eval = FALSE}
gg_line_overview + 
  ggsave("line.pdf", height = 8, width = 8)
```


For the purpose of performance, I subsample my gene expression dataset and start clustering.

```{r, eval = FALSE}
set.seed(1234)
fraction = 0.01
ods_sub <- ods[, sample(seq_len(ncol(ods)), ncol(ods)*fraction, replace = FALSE)]

k_in = 100
ods_sub = cluster_cells(ods_sub, random_seed = 123, verbose = TRUE, 
                      reduction_method = "UMAP")
```

```{r, eval = FALSE}
scheme <- rwantshue::iwanthue(seed = 42, force_init = TRUE) # recreate with a seed
# generate a new color palette (vector of hex values) with presets...


gg_cluster <- plot_cells(ods_sub, color_cells_by="cluster",
           alpha = 0.05) + 
  scale_color_manual(values = scheme$hex(23))
```

I load clustering results and plot them. 

```{r}
ods_sub_clust <- readRDS(here("R/ods_sub_clust_100"))
gg_cluster <- plot_cells(ods_sub_clust, color_cells_by="cluster", rasterize = TRUE,
           alpha = 0.5)
```

I create a graph following the following schema. I run this process in a separate script to speed up processing.

```{r, eval = FALSE}
ods_sub = learn_graph(ods_sub, verbose = TRUE, 
                        close_loop = TRUE, 
                        learn_graph_control = list(minimal_branch_len = 100))
```


```{r}
ods_sub_graph <- readRDS(here("R/ods_sub_graph_10"))
gg_path <- plot_cells(ods_sub_graph, rasterize = TRUE)
```


I save my results 

```{r}
saveRDS(ods_sub, here("data/monocle/bulk_pca_path_subsample.Rds"))
```

I create a final graph

```{r}


cowplot::plot_grid(gg_size, gg_line, 
          gg_path, #gg_proportion,
          #gg_shift, gg_ridge, 
          align = "h", axis = "bt", labels = "AUTO", ncol = 2) + 
  ggsave("figure_5.pdf", width = 6, height = 12)
```

