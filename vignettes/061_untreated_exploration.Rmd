---
title: "DMSO organoid phenotypes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

# Setup

```{r, message = FALSE}
library(tidyverse)
library(here)
library(feather)
library(monocle3)
library(ggrastr)
library(cowplot)
library(princurve)
library(readxl)
library(harmony)

# install.packages('devtools')
# devtools::install_github('VPetukhov/ggrastr')
```

I load the raw PCA dataset and give a short overview of the dataset.  

```{r, eval = TRUE}
set.seed(123)
pca_dmso_raw <- readRDS(here("vignettes/06_profiling_inspection/hdf5_pca_absolute_dmso.Rds")) # no need to filter
#pca_raw <- pca_raw_store

pca_dmso_raw %>% 
  sample_n(10000) %>%
  ggplot(aes(PC1, PC2, color = morphological_class)) + 
  geom_point() + 
  theme_classic() + 
  scale_color_viridis_d()
```

# Identify principal component cutoff

```{r}
mx <- pca_dmso_raw %>% 
  dplyr::select(contains("PC")) %>% 
  as.matrix()
  
vars <- apply(mx, 2, var)
vars <- vars/sum(vars)

plot(vars)
```

I am conservative and decide to keep the top 25 PCs. 

```{r}
pca_dmso_subset <- pca_dmso_raw %>% 
  dplyr::select(-(PC26:PC50))
```


# Import into Monocle 3

I continue importing the dataset into Monoocle3 

```{r, eval = TRUE}
# generating metadata objects
pca_anno_df <- pca_dmso_subset %>% dplyr::select(-(PC1:PC25)) %>% 
  mutate(uuid = paste(plate, well, field, object_id, sep = "_")) %>% 
  mutate(uuid2 = uuid) %>% 
  mutate(size = as.numeric(size)) %>%
  mutate(size_log = log(size)) %>%
  as.data.frame() %>% 
  column_to_rownames("uuid2")

# legacy version without corrected harmony data
pca_matrix <- pca_dmso_subset %>% dplyr::select((PC1:PC25)) %>% as.data.frame() %>% magrittr::set_rownames(pca_anno_df$uuid) %>% magrittr::set_colnames(c(paste0("PC", c(1:25)))) %>% as.matrix()

# adding batch corrected data
# pca_matrix_harmony <- harmony_id_corr %>% t() %>% magrittr::set_rownames(pca_anno_df$uuid) %>% magrittr::set_colnames(c(paste0("PC", c(1:25)))) %>% as.matrix()


cce <- new_cell_data_set(pca_matrix %>% t(), # pca_matrix_harmony %>% t()
                         cell_metadata = pca_anno_df)
```

I manually inject the PCA compression of the data into the object

```{r, eval = TRUE}
#reducedDims(ods)$PCA <- pca_matrix_harmony
reducedDims(cce)$PCA <- pca_matrix
```

I run the dim reduction methods

```{r, eval = TRUE}
set.seed(123)
cce <- reduce_dimension(cce,
                        reduction_method = "UMAP",
                        umap.n_neighbors = 15L,
                        umap.fast_sgd=TRUE, 
                        cores = parallel::detectCores(),
                        verbose = TRUE)
#harmony code
#saveRDS(ods, here("vignettes/07_organoid_unsupervised_exploration/monocle/bulk_pca_cluster_harmony.Rds"))
saveRDS(cce, here("vignettes/07_organoid_unsupervised_exploration/monocle/dmso_pca_absolute.Rds"))
```

I load the UMAP embedding of the organoid dataset. 

```{r}
cce <- readRDS(here("vignettes/07_organoid_unsupervised_exploration/monocle/dmso_pca_absolute.Rds"))

umap_tidy <- reducedDims(cce)$UMAP %>% cbind(colData(cce)) %>% as_tibble() %>% janitor::clean_names()
pca_tidy <- reducedDims(cce)$PCA %>% cbind(colData(cce)) %>% as_tibble() %>% janitor::clean_names()

```


```{r}
pca_line_mat <- pca_tidy %>% filter(drug == "DMSO") %>% 
  filter(line != "D020T01") %>%
  group_by(line) %>% 
  summarize_at(vars(contains("pc")), funs(mean))

pca_line_mat %>% as.data.frame() %>% 
  column_to_rownames("line") %>% 
  t() %>% 
  #head() %>%
  pheatmap::pheatmap(cluster_rows = FALSE,
                     cutree_cols = 6)
```


I subsample parts of my data. 

```{r}
set.seed(123)
umap_sampled <- umap_tidy %>%
  sample_frac(.01)
```

I explore the organoid size

```{r}
gg_size <- umap_sampled %>%
  #filter(Size < 1000) %>%
  ggplot(aes(v1, v2, color = size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom")

#gg_size +  ggsave(here::here("results/figures/single_organoid/gg_size.pdf"))
```

```{r}
umap_sampled %>%
  #filter(Size < 1000) %>%
  ggplot(aes(v1, v2, color = morphological_class)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  #scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom")
```

```{r}
umap_sampled %>%
  #filter(Size < 1000) %>%
  ggplot(aes(v1, v2, color = line)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  #scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom")
```


```{r}
metadata = read_excel(here::here("data/metadata/Screenings_Imaging_Manuscript.xlsx"))

pca_metadata <- metadata %>% 
  mutate(Line = paste0(donor, tumor)) %>% 
  filter(image_CTG == "Imaging") %>%
  dplyr::select(Line, Plate = barcode, screen_ID) %>% 
  #cleaning data to harmonize different naming schemes
  mutate(Plate = if_else(Line == "D020T01" & screen_ID %in% c("HC1092-9", "HC1092-10"), str_replace(Plate, "D020T01", "D020T02"), Plate)) %>%
  mutate(Line = if_else(Line == "D020T01" & screen_ID %in% c("HC1092-9", "HC1092-10"), "D020T02", Line)) %>%
  #accounting for re-imaging of plates
  separate(Plate, c("start", "end"), sep = 8, remove = FALSE) %>% 
  mutate(end = str_sub(end, 2,-1L)) %>% 
  dplyr::select(-Plate) %>%
  dplyr::rename(line = Line) %>%
  left_join(pca_dmso_subset %>% 
              separate(plate, c("start", "end"), sep = 8, remove = FALSE) %>% 
              mutate(end = str_sub(end, 2,-1L)) , .) %>% 
  dplyr::select(-start, -end) %>% 
  dplyr::rename(screen_id = screen_ID)

stopifnot(pca_metadata %>% dplyr::count(screen_id, line, plate) %>% naniar::miss_summary() %>% .$miss_df_prop == 0)
```


```{r, eval = FALSE}
set.seed(123)

pca_metadata_frac <- pca_metadata #%>% sample_frac(0.001)

pca_harmony <- pca_metadata_frac %>% dplyr::select(contains("PC"))
metadata_harmony <- pca_metadata_frac %>% dplyr::select(screen_id, line)

my_harmony_embeddings <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_id"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

umap_pre <- uwot::umap(my_harmony_embeddings$Z_orig %>% t() %>% as_tibble(), verbose = TRUE)
umap_post <- uwot::umap(my_harmony_embeddings$Z_corr %>% t() %>% as_tibble(), verbose = TRUE)

harmony_effect <- umap_pre %>% as_tibble() %>% mutate(status = "pre") %>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)%>%
  rbind(.,umap_post %>% as_tibble() %>% mutate(status = "post")%>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)) 

harmony_effect %>% saveRDS(here::here("vignettes/harmony_effect_absolute.Rds"))
```

Here we can see the effect of Harmony on batch discordances.

```{r, eval = TRUE}
harmony_effect <- readRDS(here::here("vignettes/harmony_effect_absolute.Rds"))

gg_harmony_effect <- harmony_effect %>% 
  sample_frac(0.01) %>%
  mutate(status = factor(status, levels = c("pre", "post"))) %>%
  ggplot(aes(V1, V2, color = screen_id)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  scale_color_brewer(type = "qual", palette = 2) +
  facet_wrap( ~ status) + 
  #ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/pre_post_harmony.png")) + 
  NULL
```

Still, line-specific differences are conserved in this method.

```{r}
harmony_effect %>% 
 filter(status == "post") %>%
  sample_frac(0.01) %>%
  ggplot(aes(V1, V2, color = line)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  #scale_color_brewer(type = "qual") +
  #ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/post_harmony_line.png")) + 
  NULL
```

```{r}
harmony_effect %>% 
 filter(status == "post") %>%
  sample_frac(0.1) %>%
  left_join(umap_sampled %>% 
  distinct(line, morphological_class)) %>%
  filter(morphological_class != "other") %>%
  ggplot(aes(V1, V2, color = morphological_class)) + 
  #scale_color_brewer(type = "qual", palette = 2) +
  geom_point_rast(alpha = 0.5, size = 0.7) + 
  scale_color_viridis_d() +
  theme_cowplot()


```


```{r}
df <- harmony_effect %>% 
 filter(status == "post") %>% 
  dplyr::select(-id) %>%
  cbind(umap_tidy %>% dplyr::select(-v1, -v2, -line)) %>%
  mutate(cystic = if_else(line == "D013T01" &  well == "D24" & plate == "D013T01P001L02", TRUE, FALSE)) %>%
  mutate(compact = if_else(line == "D055T01" &  well == "D24" & plate == "D055T01P007L02", TRUE, FALSE))

df %>% 
  sample_frac(0.01) %>%
  ggplot(aes(V1, V2, color = size_log)) + 
  #scale_color_brewer(type = "qual", palette = 2) +
  geom_point_rast(alpha = 0.1, size = 0.35) + 
  geom_point_rast(color = "red", alpha = 1, size = 0.5, data = df %>% filter(cystic == TRUE)) +
  geom_point_rast(color = "blue", alpha = 1, size = 0.5, data = df %>% filter(compact == TRUE)) + 
  scale_color_viridis_c() +
  theme_cowplot() + 
  coord_fixed()
```

```{r}
harmony_effect %>% 
 filter(status == "post") %>% 
  dplyr::select(-id) %>%
  cbind(umap_tidy %>% dplyr::select(-v1, -v2, -line)) %>%
  dplyr::filter(line == "D013T01" &  well == "D24" & plate == "D013T01P001L02") %>% 
  mutate(original_x = as.numeric(original_x),
         original_y = as.numeric(original_y)) %>%
  mutate(field = factor(field, levels = c(1, 2, 4, 3))) %>%
  ggplot(aes(original_x, -original_y, size = size_log, color = V1)) + 
  geom_point() + 
  facet_wrap(~field, ncol = 2) + 
  coord_fixed() +
  scale_color_viridis() +
  theme_cowplot()
```



```{r}
set.seed(123)

pca_harmony <- pca_metadata %>% dplyr::select(contains("V"))
metadata_harmony <- pca_metadata %>% dplyr::select(screen_ID, Line)

harmony_id <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

harmony_id$Z_corr %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id.Rds"))
```

