---
title: "Human Organoid Unsupervised Exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

# Setup

```{r}
library(tidyverse)
library(here)
library(feather)
library(monocle3)
library(ggrastr)
library(cowplot)
library(princurve)
library(readxl)
library(harmony)

# install.packages('devtools')
# devtools::install_github('VPetukhov/ggrastr')
```

I load the dataset in question. 

```{r, eval = TRUE}
pca_raw <- readRDS(here("vignettes/06_profiling_inspection/hdf5_pca.Rds")) # no need to filter
#pca_raw <- pca_raw_store
```

I give a short overview of the dataset. 

```{r, eval = TRUE}
pca_raw %>% 
  sample_n(10000) %>%
  ggplot(aes(V1, V2, color = morphological_class)) + 
  geom_point() + 
  theme_classic() + 
  scale_color_viridis_d()
  
```


```{r, eval = FALSE}
# for demo: subsample the original dataset
set.seed(123)

pca_raw_store <- pca_raw
pca_raw <- pca_raw %>% 
  sample_n(100000)
```

# Removing batch effects with Harmony

When looking at this data, I see that the regions within the UMAP are only present in a subset of organoid lines. When looking closer and comparing the experimental metadata with this observation, there is a real risk of these differences being batch effect. I load the experimental metadata to correct batch effects.

```{r}
metadata = read_excel(here::here("data/metadata/Screenings_Imaging_Manuscript.xlsx"))

pca_metadata <- metadata %>% 
  mutate(Line = paste0(donor, tumor)) %>% 
  filter(image_CTG == "Imaging") %>%
  dplyr::select(Line, Plate = barcode, screen_ID) %>% 
  #cleaning data to harmonize differnt naming schemes
  mutate(Plate = if_else(Line == "D020T01" & screen_ID %in% c("HC1092-9", "HC1092-10"), str_replace(Plate, "D020T01", "D020T02"), Plate)) %>%
  mutate(Line = if_else(Line == "D020T01" & screen_ID %in% c("HC1092-9", "HC1092-10"), "D020T02", Line)) %>%
  #accounting for re-imaging of plates
  separate(Plate, c("start", "end"), sep = 8, remove = FALSE) %>% 
  mutate(end = str_sub(end, 2,-1L)) %>% 
  dplyr::select(-Plate) %>%
  left_join(pca_raw %>% 
              separate(Plate, c("start", "end"), sep = 8, remove = FALSE) %>% 
              mutate(end = str_sub(end, 2,-1L)) , .) %>% 
  dplyr::select(-start, -end)

stopifnot(pca_metadata %>% dplyr::count(screen_ID, Line, Plate) %>% naniar::miss_summary() %>% .$miss_df_prop == 0)
```

First, I illustrate batch effects and how they are reduced

```{r}
set.seed(123)

pca_metadata_frac <- pca_metadata %>% sample_frac(0.001)

pca_harmony <- pca_metadata_frac %>% dplyr::select(contains("V"))
metadata_harmony <- pca_metadata_frac %>% dplyr::select(screen_ID, Line)

my_harmony_embeddings <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

umap_pre <- uwot::umap(my_harmony_embeddings$Z_orig %>% t() %>% as_tibble(), verbose = TRUE)
umap_post <- uwot::umap(my_harmony_embeddings$Z_corr %>% t() %>% as_tibble(), verbose = TRUE)

harmony_effect <- umap_pre %>% as_tibble() %>% mutate(status = "pre") %>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)%>%
  rbind(.,umap_post %>% as_tibble() %>% mutate(status = "post")%>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)) 

harmony_effect %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_effect.Rds"))
```

Here we can see the effect of Harmony on batch discordances.

```{r}
harmony_effect <- readRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_effect.Rds"))

harmony_effect %>% 
  ggplot(aes(V1, V2, color = Line)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  facet_wrap( ~ status) + 
  ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/pre_post_harmony.png"))
```

Still, line-specific differences are conserved in this method.

```{r}
harmony_effect %>% 
 filter(status == "post") %>%
  ggplot(aes(V1, V2, color = screen_ID)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  facet_wrap( ~ Line) + 
  ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/post_harmony_line.png"))
```


# Running Harmony on replicate and on replicate+line level

```{r}
set.seed(123)

pca_harmony <- pca_metadata %>% dplyr::select(contains("V"))
metadata_harmony <- pca_metadata %>% dplyr::select(screen_ID, Line)

harmony_id <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

harmony_id %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id.Rds"))
```



# Import into Monocle 3

I continue importing the dataset into Monoocle3 

```{r, eval = TRUE}
# generating metadata objects
pca_anno_df <- pca_raw %>% dplyr::select(-(V1:V25)) %>% 
  mutate(uuid = paste(Plate, Well, Field, ObjectID, sep = "_")) %>% 
  mutate(uuid2 = uuid) %>% 
  mutate(Size = as.numeric(Size)) %>%
  mutate(Size_log = log(Size)) %>%
  as.data.frame() %>% 
  column_to_rownames("uuid2")

pca_matrix <- pca_raw %>% dplyr::select((V1:V25)) %>% as.data.frame() %>% magrittr::set_rownames(pca_anno_df$uuid) %>% magrittr::set_colnames(c(paste0("PC", c(1:25)))) %>% as.matrix()


ods <- new_cell_data_set(pca_matrix %>% t(),
                         cell_metadata = pca_anno_df)
```

I manually inject the PCA compression of the data into the object

```{r, eval = TRUE}
reducedDims(ods)$PCA <- pca_matrix
```

I run the dim reduction methods

```{r, eval = TRUE}
set.seed(123)
ods <- reduce_dimension(ods,
                        reduction_method = "UMAP",
                        umap.n_neighbors = 15L,
                        umap.fast_sgd=TRUE, 
                        cores = parallel::detectCores(),
                        verbose = TRUE)

saveRDS(ods, here("vignettes/07_organoid_unsupervised_exploration/monocle/bulk_pca_cluster.Rds"))
```

I load the UMAP embedding of the organoid dataset. 

```{r}
ods <- readRDS(here("vignettes/07_organoid_unsupervised_exploration/monocle/bulk_pca_cluster.Rds"))
```

# Organoid size

I plot a size-distribution. 

```{r, eval = TRUE}
gg_size_dist <- colData(ods) %>% as_tibble() %>% 
  ggplot(aes(Size)) + 
  geom_histogram() + 
  theme_classic() 

gg_size_dist + ggsave(here("results/figures/single_organoid/gg_size_dist.pdf"))
```


I plot the cells by size

```{r, eval = FALSE}
# gg_size <- plot_cells(ods, color_cells_by="Size", 
#            alpha = 0.1,
#            rasterize= TRUE) + 
#   scale_color_viridis_c() + 
#   theme(legend.position = "bottom")
```

I use an alterantive, manual, plotting method. In order to plot the object data, I export a subset of organoids. I plot the cells by size.

```{r}
set.seed(123)

df <- reducedDims(ods)$UMAP %>% cbind(colData(ods)) %>% as_tibble() %>%
  sample_frac(.01)

gg_size <- df %>%
  #filter(Size < 1000) %>%
  ggplot(aes(V1, V2, color = Size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom") +
  theme(axis.title.x = element_text(color = "black", size = 8),
        axis.title.y = element_text(color = "black", size = 8),
        axis.text.y = element_text(color = "black", size = 8),
        axis.text.x = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8),
        legend.title = element_text(color = "black", size = 8))

```



```{r}
set.seed(123)

df <- reducedDims(ods)$UMAP %>% cbind(colData(ods)) %>% as_tibble() %>%
  sample_frac(0.1)

gg_size_supp <- df %>%
  mutate(drug = if_else(Drug == "DMSO", "DMSO", "other")) %>%
  ggplot(aes(V1, V2, color = Size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom") +
  facet_wrap(~ drug)

gg_size_supp + ggsave(here("results/figures/single_organoid/gg_size_all.pdf"))
```

# Organoid line

I create a single plot showing the two extreme organoid lines and their distribution within the embedding. 

```{r}
set.seed(123)

df <- reducedDims(ods)$UMAP %>% cbind(colData(ods)) %>% as_tibble() %>%
  filter(Drug == "DMSO") 

gg_line <- df %>% dplyr::select(-Line) %>%
  ggplot(aes(V1, V2)) + 
  geom_point_rast(alpha = 1, size = 0.35, color = "#f1f1f1") + 
  geom_point_rast(data = df %>%
                   # filter(Line %in% c("D021T01")) %>%
    filter(Line %in% c("D055T01", "D007T01", 
                       "D021T01", "D019T01", 
                       "D027T01")) %>% 
    mutate(Line = factor(Line, levels = c("D055T01", "D007T01", 
                                          "D021T01", "D019T01", 
                                          "D027T01"))),
    #mutate(Line = factor(Line, levels = c("D021T01"))),
  aes(color = Line),alpha = .2, size = 0.35, shape=16) + 
  facet_wrap( ~ Line, ncol =1) + 
  scale_color_manual(values = c(c("#D80D12", "#461C01", "#9a4c91", "#70BE6F", "#24345E"))) + 	
  #geom_density2d(color = "black") + 
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
       #caption = "control treated organoids") + 
  
  theme(axis.title.x = element_text(color = "black", size = 8),
        axis.title.y = element_text(color = "black", size = 8),
        axis.text.y = element_text(color = "black", size = 8),
        axis.text.x = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8),
        legend.title = element_text(color = "black", size = 8)) + 
  theme_cowplot(font_size = 8) + 
  theme(legend.position = "nothing")

gg_line
```



```{r}
gg_line_overview <- plot_cells(ods, color_cells_by="morphological_class",
           alpha = 0.05, label_cell_groups = FALSE,
           rasterize = TRUE) + 
  facet_wrap(~ Line) + 
  theme(legend.position = "nothing") + 
  scale_color_manual(values = rev(c("#A2549B", "#D80D12", "#6E1614","#69B563", "#A9CEE1","#1E3B87"))) 
```

I directly write this supplementary plot to disc. 

```{r, eval = TRUE}
gg_line_overview + 
  ggsave(here("results/figures/single_organoid/line.pdf"), height = 8, width = 8)
```

# Supplement

Here I collect pieces of code that did not make it into the final analysis but can be run in theory. In order to access these peaces of code, you have to open the *.RMD* file. 

```{r}
knitr::knit_exit()
```

## Running harmony on both line and batch 

```{r, eval = FALSE}
harmony_id_line <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID", "Line"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)


harmony_id_line %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id_line.Rds"))

```

