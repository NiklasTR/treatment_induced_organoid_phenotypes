---
title: "Generation of baseline expression file for PROMISE manuscript"
author: "Benedikt Rauscher"
date: "7/2/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, results='hide', warning=F, message=F, echo=F}
library(tidyverse)
library(affy)
library(org.Hs.eg.db)
```

# Aim of the analysis

Consensus molecular subtypes have recently been introduced for colorectal cancer (Guinney et al.) to divide cancer samples into logical groups with distinct molecular and functional characteristics. In order to determine these subtypes for the organoid lines of the PROMISE study, microarray experiments were performed for each line in two biological replicates. The following steps describe all steps from raw microarray data to final molecular subtype classification.

# Data preparation

In order to perform subtype classification a number of annotations is necessary that can help to link microarray probes to Entrez IDs required for subtype classification. The following code generate this mapping and in addition creates a list of reference genes whose expression will be required for the subtype classification.

```{r, results='hide', warning=F, message=F}
## id mapping derived from ENSEMBL biomart
id_mapping <- read_tsv('../data/meta/hugene_mapping.txt')
id_mapping <- id_mapping %>% `colnames<-`(c('ensg', 'probe', 'symbol', 'dummy')) %>% 
  dplyr::select(-dummy)
x <- org.Hs.egSYMBOL
mapping_all <- as.list(x[mappedkeys(x)])
mapping_all <- tibble(entrez = names(mapping_all), symbol = mapping_all) %>% 
  `colnames<-`(c('entrez', 'symbol')) %>% unnest(symbol)
id_mapping <- id_mapping %>% inner_join(mapping_all) %>% drop_na() %>% distinct()

## U133 plus2 microarray probe annotation
id_mapping_u133 <- read_tsv('../data/meta/affy_mapping2.txt') %>%
  dplyr::select(`Ensembl Gene ID`, `Affy HG U133-PLUS-2 probeset`) %>%
  `colnames<-`(c('ensg', 'probe')) %>%
  inner_join(id_mapping %>% dplyr::select(-probe))
```

# Raw data normalization

```{r, results='hide', warning=F, message=F}
## adapt path to point to folder with cel files. 
fn <- list.files('../for_GEO_submission/CEL_files/', recursive = T,
                 full.names=T, pattern = '*CEL') %>%
  .[!grepl('HuGene', .)]
sn <- paste('sample', 1:length(fn), sep='_')

## read chips
orgas_bl <- ReadAffy(filenames = fn, sampleNames = sn)
## calculate RMA corrected expression values
ex_bl <- expresso(orgas_bl,
                  bgcorrect.method='rma', 
                  normalize.method='quantiles',
                  pmcorrect.method='pmonly',
                  summary.method='avgdiff')

## remember the full matrix (for GEO submission)
full_exp_mat <- ex_bl %>% exprs()

## sample object
samples_nb <- tibble(filenames = fn, sample_names = sn) %>% 
  mutate(chip_name = basename(filenames)) %>% 
  extract(filenames, 'line', 
          regex = '[PD]*0*(\\d{1,3}).+$', 
          remove=F) %>%
  group_by(line) %>%
  mutate(rep = paste0('r', 1:n())) %>% 
  ungroup() %>%
  mutate(line = ifelse(nchar(line) == 2, paste0('D0', line), paste0('D00', line)),
         id = paste(line, rep, sep='_'))
```

Generate summarized experiment object.

```{r}
## matrix
log_expr <- full_exp_mat %>% log()
identical(samples_nb$sample_names, colnames(log_expr))
colnames(log_expr) <- samples_nb$id

## row data
row_data <- tibble(probe = rownames(log_expr)) %>% 
  left_join(distinct(id_mapping_u133) %>%
              group_by(probe) %>% dplyr::slice(1) %>% ungroup())
identical(row_data$probe, rownames(log_expr))

## col data
col_data <- samples_nb %>% select(id, line, rep, chip_name) %>% 
    as.data.frame() %>% column_to_rownames('id')
identical(rownames(col_data), colnames(log_expr))

## combine into summarized experiment object
promise_expr <- SummarizedExperiment::SummarizedExperiment(
  assays = list(expr = log_expr),
  rowData = row_data %>% as.data.frame() %>% column_to_rownames('probe'),
  colData = col_data
)

save(promise_expr, file = '~/boutroslab/promise/data/gene_expression/promise_expr.rda')
```

# Session info

```{r}
sessionInfo()
```

