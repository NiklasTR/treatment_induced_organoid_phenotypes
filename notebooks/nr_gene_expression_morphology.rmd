---
title: "Gene Expression Morphology"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r}
library(SummarizedExperiment)
library(limma)
library(glmnet)
library(pheatmap)
library(reshape2)
library(tidyverse)
library(cowplot)
library(here)
library(DESeq2)
```

Define function namespace.

```{r}
filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
slice <- dplyr::slice
count <- dplyr::count
```

Set parameters for plotting.

```{r}
theme_set(theme_cowplot())
```

# Data loading

We load the gene expression data from an Rdata object from file.

```{r}
load(here('data/processed/expression/promise_expr.rda'))

organoid_morphology <- read_delim(here::here("references/imaging/visual_classification_organoids.csv"), ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::select(line = organoid, morphology = visual_inspection_v2) %>%
  mutate(line = substr(line, 1, 4))

## annotate phenotype group
solid <- organoid_morphology  %>% 
  filter(morphology == "solid") %>%
  .$line
cystic <- organoid_morphology %>% 
  filter(morphology == "cystic") %>%
  .$line

## organoid size
organoid_size_fit <- readRDS(here::here("data/processed/morphology/organoid_size.Rds")) %>% filter(!line %in% c('D055T01', 'D021T01', 'D020T02', 'D021T01')) %>% 
  mutate(line = as.character(line)) %>% 
  dplyr::select(line, size = x, rep = replicate) %>% 
  distinct() %>% arrange(line) %>%
  mutate(line = substr(line, 1, 4)) %>% 
  mutate(rep = paste0("r", rep))

# adding metadata and filtering the promise_expr object
new_col <- colData(promise_expr) %>% as.data.frame() %>%
  left_join(., left_join(
             organoid_size_fit, 
             organoid_morphology)) %>% 
  dplyr::select(-(line:chip_name))
colData(promise_expr) <- cbind(colData(promise_expr), new_col)

promise_expr_filtered <- promise_expr[,promise_expr$line %in% (organoid_size_fit$line %>% unique())]

## long data frame
promise_long <- assays(promise_expr)$expr %>% 
  as_tibble(rownames = 'probe') %>% 
  pivot_longer(values_to = 'expr', names_to = 'id', -probe) %>%
  left_join(as_tibble(rowData(promise_expr), rownames = 'probe')) %>%
  inner_join(as_tibble(colData(promise_expr), rownames = 'id')) %>%
  select(-chip_name)

## exclude outlier
promise_long <- promise_long %>% filter(!line %in% c('D054', 'D055', 'D021'))

## adding phenotype information
promise_long <- promise_long %>% 
  mutate(phenotype = ifelse(line %in% solid, 'solid', 
                     ifelse(line %in% cystic, 'cystic', 'other'))) %>% 
  filter(phenotype != 'other')
```

# Quality control

We perform a clustering to check if the samples are grouped by line of origin.

```{r}
## make expr matrix
expr_mat <- assays(promise_expr_filtered)$expr

## generate heatmap annotation
anno <- promise_long %>% 
  distinct(line, rep, phenotype) %>% 
  unite(id, line, rep) %>% 
  mutate_all(as.factor) %>%
  as.data.frame() %>% column_to_rownames('id')

## visualize distance matrix
pheatmap(as.matrix(dist(t(expr_mat))),
         annotation_row = anno)

## visualize most variable probes
pheatmap(expr_mat[order(apply(expr_mat, 1, sd), decreasing = T)[1:500],], 
         annotation_col = anno)
```

## Feature Selection

```{r}
means <- rowMeans(assays(promise_expr_filtered)$expr)
sd <- apply(assays(promise_expr_filtered)$expr,1,sd)
cv <- sd/means
#par(mar=c(3.5,3.5,1,1),mgp=c(2,0.65,0),cex=0.9)
smoothScatter(log(means),log(cv))
```

```{r}
hist_res <- hist(cv, 100, col="#e7efd8", 
                 freq = FALSE, 
                 main = "Histogram of coefficients of variance", 
                 xlab = "CV")

top_n = cv %>% length()
top_n = top_n * 0.05

keep_probes = cv %>% sort(decreasing = TRUE) %>% .[1:top_n] 


thresh_n = min(keep_probes)

abline(v = thresh_n)
```


Keeping the top 5% probes based on the coefficient of variance. This corresponds to this number of genes:

```{r}
top_n
```


```{r}
promise_expr_filtered = promise_expr_filtered[rowData(promise_expr_filtered) %>% rownames() %in% names(keep_probes),]
```



```{r}
pca_hco <- assays(promise_expr_filtered)$expr %>% t() %>% prcomp(., scale = TRUE)
summary(pca_hco)

#Build colnames 
pca_percent <- paste(colnames(pca_hco$x), " ", "(", 
                     as.character(round(pca_hco$sdev^2 / sum(pca_hco$sdev^2) * 100, 1)),
                     "%", ")", sep="")

#Format PCA
pca_hco$x_anno <- pca_hco$x %>%
  as.data.frame() %>%
  rownames_to_column("id") %>% 
  separate(id, c("organoid", "line", "date", "array1", "array2"), sep="_") %>%
  unite(type, c("array1", "array2")) %>% mutate(type = substr(type, 1, nchar(type)-4))
```

```{r}
summary(pca_hco)$importance %>% as.data.frame() %>% 
  rownames_to_column("metric") %>% gather(PC, value, -metric) %>% 
  filter(metric == "Proportion of Variance") %>% 
  mutate(PC = factor(PC, levels = .$PC)) %>% 
  head(-1) %>% 
  ggplot(aes(PC, value)) + 
  geom_point() + 
  labs(y = "Variance explained")
```

```{r}
pca_hco$x_anno %>%
  left_join(organoid_morphology %>% rename(organoid = line)) %>%
  ggplot(aes(PC1, PC2, color = morphology)) + 
  geom_point(size = 3) + 
  theme_classic() + 
  xlab(pca_percent[1]) + 
  ylab(pca_percent[2]) +
  theme(legend.position = "bottom") + 
  ggtitle("PCA on probe level - organoid morphology")
```

```{r}


pca_hco$x_anno %>%
  left_join(organoid_size_fit %>% rename(organoid = line)) %>%
  ggplot(aes(PC1, PC2, color = size)) + 
  geom_point(size = 3) + 
  theme_classic() + 
  xlab(pca_percent[1]) + 
  ylab(pca_percent[2]) +
  theme(legend.position = "bottom") + 
  #scale_color_viridis_c() +
  scale_color_gradient(low="blue", high="red") +
  #scale_colour_gradient2() +
  ggtitle("PCA on probe level - organoid size")
```

```{r}
df = promise_long %>% 
  filter(symbol %in% c("H19")) %>% 
  dplyr::select(organoid =line, expr, line = rep)

pca_hco$x_anno %>%
  left_join(df) %>%
  ggplot(aes(PC1, PC2, color = expr)) + 
  geom_point(size = 3) + 
  theme_classic() + 
  xlab(pca_percent[1]) + 
  ylab(pca_percent[2]) +
  theme(legend.position = "bottom") + 
  scale_color_viridis_c() +
  #scale_color_gradient(low="blue", high="red") +
  #scale_colour_gradient2() +
  ggtitle("PCA on probe level - H19 expression")
```



```{r}
promise_expr_filtered

size_mat <- model.matrix(~size, colData(promise_expr_filtered))

size_fit <- limma::lmFit(assays(promise_expr_filtered)$expr, design = size_mat)
size_fit_bayes <- limma::eBayes(size_fit)

toptable = topTable(size_fit_bayes, number = Inf) %>% rownames_to_column("id") %>% 
  left_join(rowData(promise_expr_filtered) %>% as.data.frame() %>% rownames_to_column("id"))

toptable %>% ggplot(aes(P.Value)) + 
  geom_histogram(bins = 100) + 
  theme_classic() + 
  geom_vline(xintercept = 0.05) + 
  xlab("p-value")  +
  ggtitle("p-value distriutions") 
  #scale_y_log10()
```

```{r}
toptable %>% 
  filter(adj.P.Val <= 0.05) %>%
  arrange(desc(t))
```


```{r}
promise_long %>% 
  filter(symbol %in% c("H19", "MIR483", "IRS1", "SGPP2")) %>% arrange(expr) %>% arrange(line) %>% 
  group_by(line, rep, symbol) %>% 
  summarise(expr = mean(expr)) %>% 
  left_join(organoid_size_fit) %>% 
  ggplot(aes(expr, size)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~ symbol, ncol =2)
```
# Organoid size

```{r}
promise_expr_filtered

morph_mat <- model.matrix(~morphology, colData(promise_expr_filtered))

morph_fit <- limma::lmFit(assays(promise_expr_filtered)$expr, design = morph_mat)
morph_fit_bayes <- limma::eBayes(morph_fit)

toptable_morph <- topTable(size_fit_bayes, number = Inf) %>% rownames_to_column("id") %>% 
  left_join(rowData(promise_expr_filtered) %>% as.data.frame() %>% rownames_to_column("id"))

toptable_morph %>% ggplot(aes(P.Value)) + 
  geom_histogram(bins = 100) + 
  theme_classic() + 
  geom_vline(xintercept = 0.05) + 
  xlab("p-value")  +
  ggtitle("p-value distriutions") 
  #scale_y_log10()
```


```{r}
toptable_morph %>% 
  filter(adj.P.Val <= 0.05) %>%
  arrange(desc(t))
```

```{r}
promise_long %>% 
  filter(symbol %in% c("H19", "MIR483", "IRS1", "SGPP2")) %>% arrange(expr) %>% arrange(line) %>% 
  group_by(line, rep, symbol, phenotype) %>% 
  summarise(expr = mean(expr)) %>% 
  left_join(organoid_size_fit) %>% 
  ggplot(aes(phenotype, expr)) + 
  geom_point() + 
  #geom_boxplot() +
  #geom_smooth(method = "lm") + 
  facet_wrap(~ symbol, ncol =2)
```



# Unsupervised analysis

I perform a principal component analysis of individual lines at the gene level in order to develop insights into which factors drive variation in the gene expression data.

```{r}
## select most highly expressed probe to represent each gene
select_probes <- promise_long %>% group_by(symbol, probe) %>% 
  summarise(avg_probe = mean(expr)) %>% ungroup() %>%
  group_by(symbol) %>% top_n(1, avg_probe) %>% ungroup() %>% pull(probe)

## summarize replicates
gene_expr <- promise_long %>% 
  # group_by(line, symbol, probe, phenotype) %>%
  # summarise(expr = mean(expr)) %>% ungroup() %>%
  filter(probe %in% select_probes)

## get to 500 variable genes, do PCA
gene_expr_mat <- gene_expr %>% acast(symbol ~ line + rep, 
                                     value.var = 'expr')
pca <- prcomp(t(gene_expr_mat[order(apply(gene_expr_mat, 1, sd), decreasing = T)[1:500],]))

## annotate and plot pca results
pca_res <- as_tibble(pca$x, rownames = 'id') %>% select(id, PC1:PC5) %>% 
  inner_join(distinct(gene_expr %>% distinct(id, phenotype))) %>% 
  inner_join(gene_expr %>% filter(symbol == 'MIR483') %>% 
               distinct(id, IGF = expr))

pca_res %>% ggplot(aes(PC1, PC2, color = IGF, shape = phenotype)) +
  geom_point(size = 2) + 
  ggrepel::geom_text_repel(aes(label = id), min.segment.length = 0) + 
  scale_color_gradient(low = '#cccccc', high = '#111111')
```

I plot H19/IGF2 imprinting genes across lines.

```{r}
promise_long %>% mutate(symbol = ifelse(probe == '202410_x_at', 'IGF2', symbol)) %>%
  filter(symbol %in% c('H19', 'MIR483', 'IGF2')) %>%   
  ggplot(aes(line, expr, fill = phenotype)) + 
  stat_summary(fun = 'mean', geom = 'bar') + 
  geom_point() + 
  facet_wrap(~ symbol + probe, ncol = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

promise_long %>% filter(symbol %in% c('PEG10') | (probe == '214218_s_at')) %>%   
  ggplot(aes(line, expr, fill = phenotype)) + 
  stat_summary(fun = 'mean', geom = 'bar') + 
  geom_point() + 
  facet_wrap(~ symbol + probe, ncol = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Organoid size and gene expression

```{r}
promise_expr_filtered
```

