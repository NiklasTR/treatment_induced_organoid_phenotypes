---
title: "Human Organoid Unsupervised Exploration"
author: Niklas Rindtorff
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

Loading packages

```{r}
library(tidyverse)
library(here)
library(ggrastr)
library(cowplot)
library(princurve)
library(scico)
library(ggridges)

# I wish I could solve my path problems with the here() package, but experienced unreliable behavior 
# PATH = "/dkfz/groups/shared/OE0049/B110-Isilon2/promise/"
PATH = paste0(here::here(), "/")

umap_tidy <- read_rds(paste0(PATH, "data/processed/PhenotypeSpectrum/umap_absolute_all_drugs_tidy.Rds"))
umap_sampled <- read_rds(paste0(PATH, "data/processed/PhenotypeSpectrum/umap_absolute_all_drugs_sampled.Rds"))
organoid_morphology <- read_delim(here::here("references/imaging/visual_classification_organoids.csv"), ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::select(line = organoid, morphology = visual_inspection_v2)
```

# Data Filtering

We are able to observe 4 partitions in our data. 
After manual inspection, it becomes cleat that the two smallest partitions are mostly consisting of 

```{r}
umap_sampled %>% 
  ggplot(aes(v1, v2, color = factor(partition))) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_brewer(type = "qual", palette = "Set2") +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2",
       color = "partition") + 
  theme(legend.position = "bottom") + 
    coord_fixed()
```

```{r}
umap_tidy %>% 
  dplyr::count(partition) %>% 
  mutate(ratio = n/sum(n)) %>% 
  arrange(desc(ratio))
```

I remove 2 partitions from all main figures for ease of reading. Below, it is easy to toggle the removal of partitions on and off to make sure this filtering step is robust


# Organoid Size Distributions

I plot a size-distribution. 

```{r, eval = TRUE}
gg_size_dist <- umap_tidy %>% 
  filter(partition %in% c(1,2)) %>%
  ggplot(aes(size)) + 
  geom_histogram() + 
  theme_cowplot()

gg_size_dist_log <- gg_size_dist + 
  scale_x_log10() 
```

I add the eCDF.

```{r}
df <- umap_sampled %>% filter(partition %in% c(1,2))

gg_ecdf <- ggplot(df %>% filter(drug == "DMSO")) +
  stat_ecdf(aes(x = size, group = line), 
              geom = "step", size = 1) +
  #scale_color_manual(values = c("#00AFBB", "#E7B800"))+
  labs(y = "f(size)",
       x = "organoid size [pixels]") + 
  theme_cowplot()

gg_ecdf
```

For more details about distributions, please refer to *reports/Phenotypespectrum/'xyz'_dist.pdf*.

```{r}
line_param <- umap_sampled %>% filter(partition %in% c(1,2)) %>% 
  nest(-line, -replicate) %>% 
  mutate(fit = map(data, ~ fitdistrplus::fitdist(.x$size, "lnorm")),
         param = map(fit, ~ .x$estimate %>% broom::tidy()))

df <- line_param %>% unnest(param) %>% 
  filter(names == "meanlog") %>% 
  group_by(line) %>% 
  mutate(mean_meanlog = mean(x)) %>% 
  arrange(mean_meanlog) %>% 
  mutate(line = factor(line, levels = .$line %>% unique()))

organoid_size_factor <- df$line %>% levels()

df <- df %>% 
    dplyr::select(line, replicate, x) %>%
    pivot_wider(names_from = replicate, 
                values_from = x) 

r_size = df %>% ungroup() %>% dplyr::select(-line) %>% as.matrix %>% cor() %>% min()

gg_size_replicate <- df %>% 
  ggplot(aes(`1`, `2`)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  geom_point() + 
  theme_cowplot() + 
  labs(x = "Replicate 1, mu [ln size]",
       y = "Replicate 2, mu [ln size]",
       caption = paste0("2 replicates, r= ", round(r_size, 2))) + 
  coord_fixed(ratio = 1) 
  #geom_abline(slope = 1, color = "grey")
  

gg_size_replicate
```

```{r}

organoid_size_factor_09 <- umap_sampled %>% filter(partition %in% c(1,2)) %>% group_by(line) %>% 
  summarise(x = quantile(size_log, 0.9)) %>% 
  #summarise(x = mean(size_log)) %>% 
  arrange(x) %>% .$line


gg_size_dist_morph_ridge <- umap_sampled %>% filter(partition %in% c(1,2)) %>% filter(drug == "DMSO") %>% 
  mutate(line = factor(line, levels = organoid_size_factor_09)) %>% 
  ggplot() +
  geom_density_ridges_gradient(aes(y = line, x = size_log, fill = stat(x)), scale = 1) +
  #geom_density(aes(x = size_log, group = replicate, color = morphological_class)) + 
  #facet_wrap(~ line) + 
  scale_fill_viridis_c() +
  labs(caption = "DMSO treated organoids",
       x = "ln(size)",
       fill = "size") + 
  theme(legend.position = "bottom") +
  theme_cowplot() 

gg_size_dist_morph_ridge
```

```{r}
umap_size <- function(umap){
  umap %>%
  #filter(Size < 1000) %>%
  ggplot(aes(v1, v2, color = size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2",
       color = "ln(size)") + 
  theme(legend.position = "bottom") + 
    coord_fixed()
}

gg_size <- umap_size(umap_sampled %>% filter(partition %in% c(1,2)))
```



# Organoid Size during Drug Treatment


```{r}

drug_size <- umap_tidy %>% filter(partition %in% c(1,2)) %>% filter(drug == "DMSO" | drug == "Paclitaxel") %>% 
  mutate(concentration = ifelse(drug == "DMSO", 0, concentration)) %>%
  #filter(morphological_class == "disorganized") %>% 
  #filter(morphological_class != "other") %>% 
  mutate(concentration = factor(concentration, levels = c("0", "0.0016", "0.008", "0.04", "0.2", "1.0")))

ggdrug_size <- ggplot(drug_size) +
  geom_density(aes(x = log(size), group = concentration, color = concentration), size = 1.5) + 
  scico::scale_color_scico_d() +
  theme_cowplot() + 
  #scale_x_continuous(limits = c(0, 15000)) +
  theme(legend.position = "bottom") + 
  labs(color = "Paclitaxel Concentration Factor",
       title = "Organoid size distribution",
       x = "ln(size)")

ggdrug_size 
```

```{r}
drug_count <- drug_size %>%
  dplyr::count(concentration, line, replicate, well)

ggdrug_count <- ggplot(drug_count) +
  geom_density(aes(x = log(n), group = concentration, color = concentration), size = 1.5) + 
  scico::scale_color_scico_d() +
  theme_cowplot() + 
  theme(legend.position = "bottom") + 
  labs(color = "Paclitaxel Concentration Factor",
       title = "Organoid count distribution",
       x = "ln(n)")

ggdrug_count
```


```{r}
set.seed(234)
loi = c("D022T01", "D046T01")


df <- umap_tidy  %>%
  filter(partition %in% c(1,2)) %>%
  filter(drug == "DMSO" | drug == "Paclitaxel") %>% 
  mutate(concentration = ifelse(drug == "DMSO", 0, concentration)) %>% 
  filter(line == loi)

gg_drug <- umap_sampled %>% filter(partition %in% c(1,2)) %>%
  dplyr::select(-line, -concentration) %>%
  ggplot(aes(v1, v2)) + 
  geom_point_rast(alpha = 1, size = 0.35, color = "#f1f1f1") + 
  geom_point_rast(data = df  %>%
    group_by(concentration) %>% 
    sample_n(1000, replace = TRUE),
  aes(color = concentration),alpha = 1, size = 1.5, shape=16) + 
  #facet_wrap( ~ concentration, ncol = 1) + 
  #scale_color_brewer(type = "seq", palette = "YlOrRd") + 
  #geom_density2d(color = "black") + 
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2",
       caption = paste0(paste(loi, collapse=" "), ", Paclitaxel"),
       color = "Concentration Factor") + 
  scico::scale_color_scico_d() + 
  facet_wrap(~ line, ncol = 2) +
  theme(legend.position = "bottom") +
  #theme_cowplot(font_size = 8) + 
  theme(legend.position = "bottom")
 
gg_drug
```



```{r}
loi <- c("D022T01", "D055T01")

drug_size_param <- drug_size %>% 
  nest(-concentration, -line) %>% 
  mutate(fit = map(data, ~ fitdistrplus::fitdist(.x$size, "lnorm")),
         param = map(fit, ~ .x$estimate %>% broom::tidy()))

df <- drug_size_param %>% unnest(param) %>% 
  filter(names == "meanlog") %>%
  mutate(concentration = factor(concentration, levels = c("0", "0.0016", "0.008", "0.04", "0.2", "1.0"))) 

gg_size_drug <- df %>%
  filter(line %in% loi) %>%
  #mutate(concentration = as.numeric(as.character(concentration))) %>%
  ggplot(aes(concentration, x)) + 
    geom_point(color = "grey") + 
  geom_line(data = df %>% dplyr::rename(line_h = line) , aes(group = line_h), color = "grey") +
  geom_point(data = df %>% dplyr::rename(line_h = line), color = "grey") +
  geom_point(color = "black") +
  geom_line(aes(group = line), color = "black") +
  labs(y = 'mu ln(size)' ,
       x = "Concentration Factor",
       caption = paste0(paste(loi, collapse=" "), ", Paclitaxel")) +
  facet_wrap(~ line)+
  theme_cowplot()

gg_size_drug
```

# Organoid Heterogeneity

I plot 2 organoid lines treated with DMSO control

```{r}
set.seed(234)


df <- umap_tidy  %>% filter(partition %in% c(1,2)) %>%
  mutate(cystic = if_else(line == "D013T01" &  well == "D24" & plate == "D013T01P001L02", TRUE, FALSE)) %>%
  mutate(compact = if_else(line == "D055T01" &  well == "D24" & plate == "D055T01P007L02", TRUE, FALSE))

gg_cys_comp <- df %>% 
  sample_frac(0.01) %>%
  ggplot(aes(v1, v2, color = size_log)) + 
  #scale_color_brewer(type = "qual", palette = 2) +
  geom_point_rast(alpha = 0.1, size = 0.35) + 
  geom_point_rast(color = "#F4B400", alpha = 1, size = 0.5, data = df %>% filter(cystic == TRUE)) +
  geom_point_rast(color = "#DB4437", alpha = 1, size = 0.5, data = df %>% filter(compact == TRUE)) + 
  scale_color_viridis_c() +
  labs(color = "size",
       caption = "yellow: D013T01, red: D055T01",
       x = "UMAP 1",
       y = "UMAP 2") +
  theme_cowplot() + 
  coord_fixed()

gg_cys_comp
```

In general, DMSO treated organoid lines cover the same latent space than drug treated organoids. This is likely influenced by the large number of untreated organoids in the dataset.

```{r}
set.seed(123)

df <- umap_sampled %>% filter(partition %in% c(1,2))


gg_size_supp <- df %>%
  mutate(drug = if_else(drug == "DMSO", "DMSO", "other")) %>%
  ggplot(aes(v1, v2, color = size_log)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  scale_color_viridis_c() +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2") + 
  theme(legend.position = "bottom") +
  facet_wrap(~ drug)

gg_size_supp + ggsave(paste0(PATH, "reports/figures/gg_size_all.pdf"))
```

# Organoid line differences

I create a single plot showing the two extreme organoid lines and their distribution within the embedding. 

```{r}
set.seed(123)

loi <- c("D055T01", "D007T01",  "D027T01", "D018T01") #c("D055T01", "D007T01",  "D021T01", "D019T01", "D027T01")
#loi <- umap_sampled$line %>% unique()

df <- umap_sampled %>%
  filter(drug == "DMSO") %>% 
  filter(partition %in% c(1,2))


gg_line <- df %>% dplyr::select(-line) %>%
  ggplot(aes(v1, v2)) + 
  geom_point_rast(alpha = 1, size = 0.35, color = "#f1f1f1") + 
  geom_point_rast(data = umap_tidy %>%
                    filter(drug == "DMSO") %>% 
                   # filter(line %in% c("D021T01")) %>%
    filter(line %in% loi) %>% 
    mutate(line = factor(line, levels = loi)) %>% 
      sample_frac(0.1),
    #mutate(line = factor(line, levels = c("D021T01"))),
  aes(color = line),alpha = .4, size = 0.35, shape=16) + 
  facet_wrap( ~ line, ncol =2) +
  scale_color_brewer(type = "qual", palette = "Set2") +
  #scale_color_manual(values = c(c("#D80D12", "#461C01", "#9a4c91", "#70BE6F", "#24345E"))) + 	
  #geom_density2d(color = "black") + 
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
       #caption = "control treated organoids") + 
  theme_cowplot(font_size = 8) + 
  theme(legend.position = "nothing")

gg_line + ggsave(paste0(PATH, "reports/figures/gg_size_all.pdf"), width = 4, height = 4)
```
I am focusing on cystic vs solid organoid lines

```{r}
#UMAP Cystic (Lines 18, 13, 27, 30) vs. Solid (others) treated with DMSO, for Figure 1 / matching expression analysis done for cystic vs. rest

set.seed(123)

# TODO reference morphology from
cystic_l <- organoid_morphology %>% filter(morphology == "cystic") %>%.$line %>% paste0(., "01")
dense_l <- organoid_morphology %>% filter(morphology == "solid") %>%.$line %>% paste0(., "01")

df <- umap_tidy %>%
  filter(drug == "DMSO") %>% 
  filter(partition %in% c(1,2)) %>%
  mutate(morphology = case_when(line %in% cystic_l ~ "cystic",
                                line %in% dense_l ~ "dense",
                                 TRUE ~ "other"))

gg_cystic <- umap_sampled %>% 
  ggplot(aes(v1, v2)) + 
  geom_point_rast(alpha = 1, size = 0.35, color = "#f1f1f1") + 
  
  # geom_point_rast(data = df %>%
  #   filter(morphology == "cystic") %>% 
  #     sample_frac(0.05),
  # aes(color = morphology),alpha = .4, size = 0.35, shape=16) + 
  
  geom_density_2d(data = df %>%
    filter(morphology != "other") %>% 
      sample_frac(0.05),
  aes(color = morphology), size = 1.5) +

  scale_color_brewer(type = "qual", palette = "Set2") +
  #scale_color_manual(values = c(c("#D80D12", "#461C01", "#9a4c91", "#70BE6F", "#24345E"))) + 	
  #geom_density2d(color = "black") + 
  theme_classic() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
       #caption = "control treated organoids") + 
  theme_cowplot(font_size = 8) + 
  #theme(legend.position = "nothing")  + 
  coord_fixed()


gg_cystic
```


# Plot Export

```{r}
#gg_size_dist + ggsave(paste0(PATH, "reports/figures/gg_size_dist.pdf"))
#gg_size_dist_log +  ggsave(paste0(PATH, "reports/figures/gg_size_dist_log.pdf"))
#ggdrug_size + ggsave(paste0(PATH, "reports/figures/gg_drug_dist_size_log.pdf"))
#gg_ecdf + ggsave(paste0(PATH, "reports/figures/gg_size_dist_ecdf.pdf"))
#gg_size_dist_morph_ridge +  ggsave(paste0(PATH, "reports/figures/gg_size_dist_morph_ridge.pdf"), width = 4, height = 4)

# ggdrug_count + ggsave(paste0(PATH, "reports/figures/gg_drug_dist_n_log.pdf"))
# gg_drug + ggsave(paste0(PATH, "reports/figures/gg_drug.pdf"), width = 8, height = 4)
# gg_size_drug + ggsave(paste0(PATH, "reports/figures/gg_trametinib_size_dose.pdf"), width = 3.65, height = 3.65)
gg_cystic + ggsave(paste0(PATH, "reports/figures/gg_cystic.pdf"), width = 4, height = 4)
```

```{r}
plot_grid(plot_grid(gg_size_dist_morph_ridge, gg_size_replicate, labels = c('A', 'B'), label_size = 12, ncol = 2),
          gg_size,
          plot_grid(gg_line, gg_cystic, labels = c('D', 'E'), label_size = 12, ncol = 2),
          labels = c('', 'C', ''), label_size = 12, ncol = 1) +
  ggsave(paste0(PATH, "reports/panels/panel_size_dist.pdf"), width = 8, height = 16)

plot_grid(plot_grid(ggdrug_size, ggdrug_count, labels = c('A', 'B'), label_size = 12),
          gg_drug,
          gg_size_drug,
          labels = c('', 'C', 'D'), label_size = 12, ncol = 1) +
  ggsave(paste0(PATH, "reports/panels/panel_size_drug.pdf"), width = 8, height = 12)

gg_size_supp

```


# Supplement

Here I collect pieces of code that did not make it into the final analysis but can be run in theory. In order to access these peaces of code, you have to open the *.RMD* file. 

```{r}
knitr::knit_exit()
```





















## Mixture modeling of Organoid size distribution


I estimate a log-gaussian mixture model of organoid size.

```{r, eval = TRUE}
library(mixtools)

df_mix <- normalmixEM(umap_tidy$size_log, k = 2)

df_fus <- df %>% dplyr::select(size_log) %>% mutate(posterior = "joined") %>% 
  rbind(data.frame(size_log = df_mix$x,
                   posterior = df_mix$posterior %>% as.data.frame() %>% round() %>% .$comp.1))

ggplot(df) + 
  geom_density(aes(x = size_log, y=..count..), alpha = 0.2) + 
  theme_cowplot()

ggplot(df_fus) + 
  geom_density(aes(x = size_log, y=..count.., fill = posterior), alpha = 0.2) + 
  theme_cowplot()
```

```{r, eval = TRUE}
df_mix
```



I scale this approach to all other organoid lines. 

```{r}
set.seed(0123349)

umap_mix <- umap_tidy %>% filter(drug == "DMSO")  %>% 
  nest(-line, -replicate) %>%
  mutate(mix_fit = map(data, ~ normalmixEM(.x$size_log, k = 2, maxit = 5000)),
         prob = map(mix_fit, ~ .x$posterior %>% as.data.frame() %>% .$comp.1)) 

umap_mix = umap_mix %>% unnest(prob, data) 
```

```{r}
set.seed(0.1)

df = umap_mix %>% mutate(posterior = round(prob)) %>% mutate(posterior = factor(posterior))

df %>% 
  sample_frac(0.01) %>%
  ggplot(aes(prob_dead, fill = posterior)) + 
  geom_histogram() + 
  scale_fill_brewer(type= "qual") + 
  scale_y_log10() + 
  theme_cowplot()

ggplot(df) + 
  geom_density(aes(x = size_log, fill = posterior, group = replicate), alpha = 0.5) + 
  facet_wrap(~ line) + 
  labs(caption = "Plotted are Replicates, DMSO treated organoids",
       x = "ln(size)") + 
  theme(legend.position = "bottom") +
  theme_cowplot()


ggplot(df) + 
  geom_density(aes(x = size_log, y=..count.., fill = posterior), alpha = 0.2) + 
  theme_cowplot() + 
  facet_wrap(~ line)
```

## Count distribution of Paclitaxel treated organoids 



```{r}
drug_count_param <- drug_count %>% 
  nest(-concentration, -line) %>% 
  mutate(fit = map(data, ~ fitdistrplus::fitdist(.x$n, "lnorm")))
        # param = map(fit, ~ .x$estimate %>% broom::tidy()))

drug_count_param %>% unnest(param) %>% 
  filter(names == "meanlog") %>%
  ggplot(aes(concentration, exp(x))) + 
    geom_point() + 
  theme_cowplot()
```


```{r}
drug_count_param %>% unnest(param) %>% 
  filter(names == "meanlog") %>% 
  dplyr::select(concentration, line, count = x) %>% 
  left_join(tram_size_param %>% unnest(param) %>% 
  filter(names == "meanlog") %>% dplyr::select(concentration, line, size = x)) %>% 
  
  ggplot(aes(count, size, color = concentration)) + 
  geom_point() + 
 # geom_path(aes(group = line)) +
  scico::scale_color_scico_d() + 
  theme_cowplot()


```




## Main Panel

```{r}
plot_grid(gg_size, 
          plot_grid(gg_line,
                    gg_bortezomib,
                    ncol = 2),
          labels = "AUTO",
          ncol = 2) + 
  gggsave(here::here("results/figures/panel_6.pdf"))
```

## Supplemental Panel

```{r}
plot_grid(gg_harmony_effect, 
          gg_size_supp,
          gg_size_dist
          )
```

## Running harmony on batches

We abandoned this approach as we did not screen organoid lines across batches. Reducing batch differences automatically led to a reduction of line specific effects. 


First, I illustrate batch effects and how they are reduced

```{r, eval = FALSE}
set.seed(123)

pca_metadata_frac <- pca_metadata %>% sample_frac(0.001)

pca_harmony <- pca_metadata_frac %>% dplyr::select(contains("V"))
metadata_harmony <- pca_metadata_frac %>% dplyr::select(screen_ID, Line)

my_harmony_embeddings <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

umap_pre <- uwot::umap(my_harmony_embeddings$Z_orig %>% t() %>% as_tibble(), verbose = TRUE)
umap_post <- uwot::umap(my_harmony_embeddings$Z_corr %>% t() %>% as_tibble(), verbose = TRUE)

harmony_effect <- umap_pre %>% as_tibble() %>% mutate(status = "pre") %>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)%>%
  rbind(.,umap_post %>% as_tibble() %>% mutate(status = "post")%>% cbind(id = 1:nrow(.)) %>% cbind(metadata_harmony)) 

harmony_effect %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_effect.Rds"))
```

Here we can see the effect of Harmony on batch discordances.

```{r, eval = TRUE}
harmony_effect <- readRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_effect.Rds"))

gg_harmony_effect <- harmony_effect %>% 
  mutate(status = factor(status, levels = c("pre", "post"))) %>%
  ggplot(aes(V1, V2, color = screen_ID)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  scale_color_brewer(type = "qual", palette = 2) +
  facet_wrap( ~ status) + 
  #ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/pre_post_harmony.png")) + 
  NULL
```

Still, line-specific differences are conserved in this method.

```{r}
harmony_effect %>% 
 filter(status == "post") %>%
  ggplot(aes(V1, V2, color = screen_ID)) + 
  geom_point_rast(alpha = 0.5, size = 0.35) + 
  theme_cowplot() + 
  facet_wrap( ~ Line) + 
  scale_color_brewer(type = "qual") +
  #ggsave(here::here("vignettes/07_organoid_unsupervised_exploration/post_harmony_line.png")) + 
  NULL
```


## Running Harmony on replicate and on replicate+line level

```{r, eval = FALSE}
set.seed(123)

pca_harmony <- pca_metadata %>% dplyr::select(contains("V"))
metadata_harmony <- pca_metadata %>% dplyr::select(screen_ID, Line)

harmony_id <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)

harmony_id$Z_corr %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id.Rds"))
```

I load the Harmony results.

```{r, eval = FALSE}
harmony_id_corr <- readRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id.Rds"))
```



## Running harmony on both line and batch 

```{r, eval = FALSE}
harmony_id_line <- HarmonyMatrix(
  pca_harmony, metadata_harmony, c("screen_ID", "Line"),
  do_pca = FALSE,
  verbose = TRUE, 
  return_object = TRUE
)


harmony_id_line %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/harmony/harmony_pca_id_line.Rds"))

```

## Individual Pseudotimes


```{r, eval = FALSE}
set.seed(123)

drug_order <- umap_tidy %>%
  dplyr::select(drug) %>%
    filter(grepl(drug, pattern = "__")) %>% .$drug %>% unique() %>% sort()

curve_df <- umap_tidy %>%
    filter(drug %in% drug_order) %>%
  mutate(drug = factor(drug, levels =drug_order)) %>% 
  arrange((drug)) %>% 
  group_by(drug, line) %>%
  sample_n(1000, replace = TRUE) %>% # adjust based on pan-line vs. line level 
  ungroup() %>% 
  # running the princcurve algorithm
  separate(drug, c("compound", "concentration"), sep = "__", remove = FALSE) %>%
  nest(-compound, -line) %>%
  #head(10) %>% 
  mutate(plot = purrr::map(data, ~ create_princurve_trace(.x)))

curve_df %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/curve_df.Rds"))
```


```{r, eval = FALSE}
set.seed(123)

drug_order <- umap_tidy %>%
  dplyr::select(drug) %>%
    filter(grepl(drug, pattern = "__")) %>% .$drug %>% unique() %>% sort()

curve_df <- umap_tidy %>%
    filter(drug %in% drug_order) %>%
  mutate(drug = factor(drug, levels =drug_order)) %>% 
  arrange((drug)) %>% 
  group_by(drug, line) %>%
  sample_n(1000, replace = TRUE) %>% # adjust based on pan-line vs. line level 
  ungroup() %>% 
  # running the princcurve algorithm
  separate(drug, c("compound", "concentration"), sep = "__", remove = FALSE) %>%
  nest(-compound, -line) %>%
  #head(10) %>% 
  mutate(plot = purrr::map(data, ~ create_princurve_trace(.x)))

curve_df %>% saveRDS(here::here("vignettes/07_organoid_unsupervised_exploration/curve_df.Rds"))
```


```{r, eval = FALSE}
gg_curve_df <- curve_df %>% 
  mutate(compound_line = paste0(compound, "__", line)) %>%
  mutate(plot_trace = purrr::map(plot, ~ .x$fit %>% .[, ])) %>% 
  unnest(plot_trace) 

gg_curve_df %>%
  ggplot(aes(v1, v2)) + 
  geom_point(data = curve_df %>% unnest(data),
             aes(color = compound), alpha = 0.05, size = 0.35) +
  
  geom_path(aes(group = compound_line, color = compound_line), size = 1.5, arrow = arrow(angle = 10, ends = "last", type = "closed", length = unit(0.15, "inches"))) + 
  
  facet_grid(~ compound) +
   
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
  theme(legend.position = "bottom")
```

## Plotting gigantic overview figure


```{r, eval = FALSE}
gg_line_overview <- plot_cells(ods, color_cells_by="morphological_class",
           alpha = 0.05, label_cell_groups = FALSE,
           rasterize = TRUE) + 
  facet_wrap(~ Line) + 
  theme(legend.position = "nothing") + 
  scale_color_manual(values = rev(c("#A2549B", "#D80D12", "#6E1614","#69B563", "#A9CEE1","#1E3B87"))) 
```

I directly write this supplementary plot to disc. 

```{r, eval = FALSE}
gg_line_overview + 
  ggsave(here("results/figures/single_organoid/line.pdf"), height = 8, width = 8)
```

## Running princurve on principle component data 


 In the past, I estimated a princurve directly from the UMAP embedding. I am not sure this is a good idea. Rather, I am going to test running the princurve algorithm on a set of PCs. 
What is the %-Variance explained per PC?

```{r}
vars_pca <- apply(reducedDims(ods)$PCA, 2, var)
vars_pca_scaled = vars_pca/sum(vars_pca)

vars_pca_scaled %>% plot()
```

This is the PCA-based princurve function. 

```{r}
create_princurve_trace_pca <- function(df){
  df_tmp_init <- df %>% 
  group_by(drug) %>% 
  summarise_at(vars(contains("pc")), funs(mean)) %>%
  ungroup()
  
  fit <- principal_curve(x = df %>% dplyr::select(pc1:pc5) %>% as.matrix(),
                       start = df_tmp_init %>% dplyr::select(pc1:pc5) %>% as.matrix(),
                       approx_points = FALSE, 
                       trace = TRUE, 
                       plot_iterations = FALSE, 
                       maxit = 30,
                       stretch =2)
  
  plot(fit)
  points(df_tmp_init%>% dplyr::select(pc1:pc5) %>% as.matrix())

  result <- list()
  
  result$fit <- fit$s[fit$ord,] %>% as_tibble()
  result$center <- df_tmp_init
  result$input <- df
  
  return(result)
}
```


```{r}
set.seed(123)

drug_order <- pca_tidy %>%
  dplyr::select(drug) %>%
    filter(grepl(drug, pattern = "__")) %>% .$drug %>% unique() %>% sort()

curve_df <- pca_tidy %>%
    filter(drug %in% drug_order) %>%
  mutate(drug = factor(drug, levels =drug_order)) %>% 
  arrange((drug)) %>% 
  group_by(drug, line) %>%
  sample_n(1000, replace = TRUE) %>% # adjust based on pan-line vs. line level 
  ungroup() %>% 
  # running the princcurve algorithm
  separate(drug, c("compound", "concentration"), sep = "__", remove = FALSE) %>%
  nest(-compound, -line) %>%
  head(1) %>% 
  mutate(plot = purrr::map(data, ~ create_princurve_trace_pca(.x)))
```


```{r}
set.seed(123)

gg_curve_df <- curve_df %>% 
  mutate(compound_line = paste0(compound, "__", line)) %>%
  mutate(plot_trace = purrr::map(plot, ~ .x$fit %>% .[, ])) %>% 
  unnest(plot_trace) 

pca_subset = pca_tidy %>% sample_frac(.01)
sample_index = pca_subset$uuid


curve_index = FNN::get.knnx(data = pca_subset %>% dplyr::select(pc1:pc5) %>% as.matrix(), gg_curve_df %>% dplyr::select(pc1:pc5) %>% as.matrix(), k=1, algorithm=c("kd_tree"))

gg_curve_df = cbind(gg_curve_df, umap_tidy %>% filter(uuid %in% sample_index) %>% .[curve_index$nn.index,] %>% dplyr::select(v1, v2))

gg_curve_df %>%
  ggplot(aes(v1, v2)) + 
  geom_point(data = curve_df %>% unnest(data) %>% dplyr::select(compound, line, uuid) %>% left_join(umap_tidy %>% dplyr::select(uuid, v1, v2)),
             aes(color = compound), alpha = 0.05, size = 0.35) +
  
  #geom_path(aes(group = compound_line, color = compound_line), size = 1.5, arrow = arrow(angle = 10, ends = "last", type = "closed", length = unit(0.15, "inches"))) + 
  geom_point(aes(group = compound_line, color = compound_line), size = 1.5) +
  #facet_grid(~ compound) +
  facet_wrap(~ compound_line) +
  theme_cowplot() +
  labs(x = "UMAP 1",
       y = "UMAP 2")+
  theme(legend.position = "bottom")
```


