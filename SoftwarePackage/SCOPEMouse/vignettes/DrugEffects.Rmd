---
title: "Drug-Induced Phenotypes"
author: "Jan Sauer"
date: "`r Sys.Date()`"
output: 
   BiocStyle::html_document:
    code_folding: hide
    df_print: paged
    toc_depth: 4
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Organoid Viability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, message=FALSE}
library(pheatmap)
library(ggplot2)
library(reshape2)
library(knitr)
library(tidyverse)
library(SCOPEMouse)

# knitr::opts_chunk$set(cache = TRUE, warning = FALSE, 
#                       message = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

# Load data
# Load data
data("drug_effects", package = "SCOPEMouse")

# Define colors
full_color_scale = c(
  "#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", 
  "#911eb4", "#46f0f0", "#f032e6", "#d2f53c", "#fabebe", 
  "#008080", "#e6beff", "#aa6e28", "#fffac8", "#800000", 
  "black", "darkgray", "lightgray", "white")

# Lines
lines = get_lines()
colorScale = setNames(
  object = full_color_scale[seq_along(lines)], 
  nm = lines)

# Define a base theme for the plots
# Modified from https://rpubs.com/Koundy/71792
theme_vignette <- function(base_size=14, base_family="Helvetica") {
  library(grid)
  library(ggthemes)
  (theme_foundation(base_size=base_size, base_family=base_family)
    + theme(plot.title = element_text(face = "bold",
                                      size = rel(1.2), hjust = 0.5), 
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust = 0),
            text = element_text(),
            panel.background = element_rect(colour = NA),
            plot.background = element_rect(colour = NA),
            panel.border = element_rect(colour = NA),
            axis.title = element_text(face = "bold",size = rel(1)),
            axis.title.y = element_text(angle=90,vjust =2),
            axis.title.x = element_text(vjust = -0.2),
            axis.text = element_text(), 
            axis.line = element_line(colour="black"),
            axis.ticks = element_line(),
            # panel.grid.major = element_line(colour="#f0f0f0"),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(colour = NA),
            legend.position = "right",
            legend.direction = "vertical",
            legend.key.size= unit(0.5, "cm"),
            legend.spacing = unit(1, "cm"),
            legend.title = element_text(face="italic"),
            plot.margin=unit(c(10,5,5,5),"mm"),
            strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
            strip.text = element_text(face="bold")))
}

theme_vignette_color <- function(...){
  library(scales)
  discrete_scale(
    aesthetics = c("colour", "color"), scale_name = "theme_vignette",
    palette = manual_pal(values = unname(colorScale)), ...)
}

theme_vignette_fill <- function(...){
  library(scales)
  discrete_scale(
    aesthetics = c("fill"), scale_name = "theme_vignette",
    palette = manual_pal(values = unname(colorScale)), ...)
}

# Flag whether images should be saved additionally as PDF files
save_images = FALSE
img_output_dir = "images"
if(save_images) if(!dir.exists(img_output_dir)) dir.create(img_output_dir)

# This function gets angles between row vectors
get_angles = function(row_vectors) {
  norm_vectors = t(apply(
    row_vectors, 1, function(x) x / sqrt(sum(x**2, na.rm = TRUE))))
  dotprod = norm_vectors %*% t(norm_vectors)
  diag(dotprod) = 1
  # return(acos(dotprod) * 180/pi)
  return(dotprod)
}
```

# Defining Active Drugs
A histogram of the accuracies (or AUCs to be exact) shows that there are two groups of drugs. The first, normally distributed, group with low AUCs represents the inactive drugs that cannot be sufficiently differentiated from DMSO while the other group represents the active drugs that have significantly different characteristic features than the DMSO organoids and can be separated by a linear SVM hyperplane in feature space.
```{r auroc_hist}
ggplot(data = drug_effect_metadata, mapping = aes(x = AUC_Mean)) + 
  geom_histogram(bins = 50) + facet_wrap(facets = ~Line) + 
  theme_vignette() + ggtitle("AUROC Histogram") + 
  xlab("Mean AUROC (10-fold Cross Validation)") + ylab("") + 
if(save_images) ggsave(
  filename = file.path(img_out_dir, "Histogram_ClassifierAUCs.pdf"), 
  width = 3, height = 3, useDingbats = FALSE)
```

The distance in feature space between drugs and DMSO clouds correlates, as expected, with the AUROC.
```{r dist_vs_auroc}
# Correlations
ggplotdf = drug_effect_metadata
ggplotdf$Label = NA
for(line in lines) {
  line_md = ggplotdf %>% filter(Line == line)
  corr = round(cor(line_md$AUC_Mean, line_md$Distance, method = "spearman"), 3)
  ggplotdf$Label[ggplotdf$Line == line] = paste0(line, "; r = ", corr)
}
ggplot(data = ggplotdf, mapping = aes(x = AUC_Mean, y = Distance)) + 
  geom_point(size = 0.5) + facet_wrap(facets = ~Label) + 
  theme_vignette() + 
  xlab("AUROC") + labs(color = "")
if(save_images) ggsave(
  filename = file.path(img_out_dir, "Scatterplot_AUCvsDistance.pdf"), 
  width = 3, height = 3, useDingbats = FALSE)
```

The SVM was trained with 10-fold cross validation and the resulting means and standard devations of the accuracies are shown below.
```{r auroc_mean_vs_auroc_std}
ggplot(data = drug_effect_metadata, mapping = aes(x = AUC_Mean, y = AUC_Std)) + 
  geom_point(size = 0.5) + theme_vignette() + facet_wrap(facets = ~Line) + 
  labs(x = "AUROC Mean", y = "AUROC Standard Deviation", color = "")
if(save_images) ggsave(
  filename = file.path(img_out_dir, "Scatterplot_AUCMeanvsAUCStd.pdf"), 
  width = 3, height = 3, useDingbats = FALSE)
```

Based on the bimodal histogram of active drugs, I define any drug that can be separated with $AUC = 0.85$ from the DMSO controls as "active".
```{r select_active_profiles}
auc_thresh = 0.85
profiles_active = drug_effect_profiles[drug_effect_metadata$AUC_Mean >= auc_thresh, ]
metadata_active = drug_effect_metadata[drug_effect_metadata$AUC_Mean >= auc_thresh, ]
```

The number of active drugs varies per line.
```{r active_drugs_per_line}
ggplot_df = as.data.frame(table(metadata_active$Line))
# D054T01 was only imaged with the small library
ggplot_df$TextLoc = ggplot_df$Freq - 50
ggplot(data = ggplot_df, mapping = aes(x = Var1, y = Freq)) + 
  geom_col() + 
  geom_text(mapping = aes(x = Var1, y = TextLoc, label = Freq), 
            color = "white", fontface = "bold", size = 3) + 
  theme_vignette() + 
  theme(axis.line = element_blank(), axis.text.x = element_blank(), 
        axis.ticks = element_blank()) + 
  xlab("") + ylab("") + ggtitle("Number of Active Drugs") + 
  coord_flip()
if(save_images) ggsave(
  filename = file.path(img_out_dir, "Barplot_NumActiveDrugs.pdf"),
  width = 2.5, height = 3)
```

Some drugs are active in all cell lines and others only in very few.
```{r cell_lines_per_drug}
activity_table = table(metadata_active$Drug, metadata_active$Line)
ggplot_df = as.data.frame(sort(rowSums(activity_table > 0), decreasing = TRUE))
colnames(ggplot_df) = "Freq"
ggplot_df$X = seq_len(nrow(ggplot_df))
ggplot(data = ggplot_df, mapping = aes(x = X, y = Freq)) +
  geom_line() + theme_vignette() +
  xlab("Drugs") + ylab("Number of Lines") +
  ggtitle("Number of Lines in which a Drug is Active") +
  scale_y_continuous(breaks = seq_len(length(lines)))
```

# Drug Effect Vector Clustering
```{r}
annotation = data.frame(
  "Pathway" = get_mode_of_action(metadata_active$Drug),
  "Target" = get_targets(metadata_active$Drug),
  "Line" = metadata_active$Line,
  row.names = rownames(profiles_active),
  stringsAsFactors = FALSE)

# Fix for slahes
annotation$Target = gsub(
  pattern = "/", replacement = ", ", annotation$Target)

line_results = list()
enriched_drugs = list()
oddsratio_pathway = list()
oddsratio_target = list()
for(line in unique(substr(rownames(annotation), 1, 7))) {
  line_sel_indices = annotation$Line == line
  line_annotation = annotation[line_sel_indices, ]
  line_annotation$Line = NULL
  line_profiles = profiles_active[line_sel_indices, ]
  line_metadata = metadata_active[line_sel_indices, ]
  
  # Calc angles and cluster
  angles = get_angles(line_profiles)
  if(nrow(angles) < 2) next
  d = acos(angles)*180/pi
  hc = hclust(as.dist(d), method = "ward.D2")
  
  # Also cluster the principal components by correlation just for kicks
  cor_pca = cor(line_profiles)
  d_pca = as.dist((1 - cor_pca) / 2)
  hc_pca = hclust(d_pca, method = "ward.D2")
  
  # Annotate Pathway and Targets
  pathways = list()
  for(pathway in unique(line_annotation$Pathway)) {
    pathways[[pathway]] = grep(
      pattern = paste0("\\b", pathway, "\\b"), 
      x = line_annotation$Pathway, 
      ignore.case = TRUE)
  }
  # My cluster_enrichment function doesn't play well with NA values yet
  pathways = pathways[!is.na(names(pathways))]
  pathways_sig_vec = get_cluster_enrichment(
    clustering = hc, labels = pathways, min_cluster_size = 5, 
    max_annotated_labels = 7)
  # 'Others' is too vague
  pathways_sig_vec$Labels[pathways_sig_vec$Labels == "Others"] = NA
  
  targets_split = tolower(line_annotation$Target)
  targets = list()
  for(target in unique(unlist(strsplit(targets_split, ", ")))) {
    targets[[target]] = grep(
      pattern = paste0("\\b", target, "\\b"), 
      x = targets_split, ignore.case = TRUE)
  }
  # My cluster_enrichment function doesn't play well with NA values yet
  targets = targets[!is.na(names(targets))]
  targets_sig_vec = get_cluster_enrichment(
    clustering = hc, labels = targets, min_cluster_size = 5, 
    max_annotated_labels = 7)
  
  line_annotation$Pathway = pathways_sig_vec$Labels
  line_annotation$Target = targets_sig_vec$Labels

  enriched_drugs[[line]] = data.frame(
    "Drug" = substr(rownames(line_annotation), 9, 100000L), 
    "Line" = line,
    "Pathway" = annotation[annotation$Line == line, "Pathway"], 
    "Target" = annotation[annotation$Line == line, "Target"],
    "Enriched.Target" = line_annotation$Target,
    "is.pathway.enriched" = !is.na(line_annotation$Pathway), 
    "is.target.enriched" = !is.na(line_annotation$Target),
    stringsAsFactors = FALSE)
  
  if(nrow(pathways_sig_vec$Fisher.Test) > 0) {
    oddsratio_pathway[[line]] = cbind.data.frame(
      "Line" = line, pathways_sig_vec$Fisher.Test)
  }
  if(nrow(targets_sig_vec$Fisher.Test) > 0) {
    oddsratio_target[[line]] = cbind.data.frame(
      "Line" = line, targets_sig_vec$Fisher.Test)
  }
  
  line_results[[line]] = list(
    "Annotation" = line_annotation, 
    "Distances" = d, 
    "Clustering" = hc, 
    "PCAClustering" = hc_pca)
}

# Save enriched drugs
enriched_drugs = do.call(rbind, enriched_drugs)
rownames(enriched_drugs) = NULL
write.csv2(
  x = enriched_drugs, file = "EnrichedDrugs.csv", 
  quote = FALSE, row.names = FALSE)

# Save oddsratio Ratios
oddsratio_pathway = do.call(rbind, oddsratio_pathway)
rownames(oddsratio_pathway) = NULL
write.csv2(
  x = oddsratio_pathway, file = "OddsRatio_Pathways.csv", 
  quote = FALSE, row.names = FALSE)
oddsratio_target = do.call(rbind, oddsratio_target)
rownames(oddsratio_target) = NULL
write.csv2(
  x = oddsratio_target, file = "OddsRatio_Target.csv", 
  quote = FALSE, row.names = FALSE)

anno_colorScale = list()

for(line in names(line_results)) {
  line_annotation = line_results[[line]]$Annotation
  line_profiles = profiles_active[annotation$Line == line,]
  line_color = anno_colorScale
  if(sum(!is.na(line_annotation$Pathway)) == 0) line_annotation$Pathway = NULL
  if(sum(!is.na(line_annotation$Target)) == 0) line_annotation$Target = NULL
  for(column in colnames(line_annotation)) {
    if(column %in% names(line_color)) next
    entries = na.omit(unique(line_annotation[[column]]))
    line_color[[column]] = setNames(
      object = unname(full_color_scale)[seq_along(entries)], 
      nm = entries)
  }
  d = line_results[[line]]$Distances
  hc = line_results[[line]]$Clustering
  hc_pca = line_results[[line]]$PCAClustering
  lp = line_profiles
  lp[lp > 0] = sqrt(lp[lp > 0])
  lp[lp < 0] = -sqrt(-lp[lp < 0])
  
  hm_range_limit = max(abs(lp))
  hm_breaks = seq(-hm_range_limit, hm_range_limit, length.out = 100)
  hm_legend_breaks = c(-floor(hm_range_limit), 0, floor(hm_range_limit))
  hm_legend_labels = hm_legend_breaks**2
  hm_legend_labels[hm_legend_breaks < 0] = -hm_legend_labels[hm_legend_breaks < 0]
  hm_colorscale = colorRampPalette(
    c("#0082c8", "white", "#e6194b"))(length(hm_breaks))
  
  pheatmap(
      t(lp), annotation_col = line_annotation,
      color = hm_colorscale, breaks = hm_breaks,
      legend_breaks = hm_legend_breaks, legend_labels = hm_legend_labels,
      annotation_colors = line_color, show_rownames = TRUE,
      show_colnames = FALSE, cluster_rows = hc_pca, cluster_cols = hc,
      main = sprintf("Angles Between Profile Vectors for %s", line),
      border_color = NA, cellheight = 7, cellwidth = 1)
  if(save_images) pheatmap(
      t(lp), annotation_col = line_annotation, 
      color = hm_colorscale, breaks = hm_breaks,
      legend_breaks = hm_legend_breaks, legend_labels = hm_legend_labels,
      annotation_colors = line_color, show_rownames = TRUE, 
      show_colnames = FALSE, cluster_rows = hc_pca, cluster_cols = hc, 
      main = sprintf("Angles Between Profile Vectors for %s", line), 
      border_color = NA, cellheight = 7, cellwidth = 1, height = 10,
      filename = file.path(img_out_dir, sprintf("EffectVectorHeatmap_PCA_%s.pdf", line)))
  
  hm_colorscale = colorRampPalette(
    rev(c("#f7f7f7", "#f7f7f7", "#f7f7f7", 
          "#E0F3F8", "#91BFDB", "#4575B4")))(150)
  
  pheatmap(
      d, annotation_col = line_annotation,
      color = hm_colorscale, annotation_colors = line_color, 
      show_rownames = FALSE, show_colnames = FALSE, 
      cluster_rows = hc, cluster_cols = hc,
      main = sprintf("Angles Between Profile Vectors for %s", line),
      border_color = NA, cellheight = 1.25, cellwidth = 1.25)
  if(save_images) pheatmap(
      d, annotation_col = line_annotation,
      color = hm_colorscale, annotation_colors = line_color, 
      show_rownames = FALSE, show_colnames = FALSE, 
      cluster_rows = hc, cluster_cols = hc,
      main = sprintf("Angles Between Profile Vectors for %s", line),
      border_color = NA, cellheight = 1.25, cellwidth = 1.25, height = 10,
      filename = file.path(img_out_dir, sprintf("EffectVectorHeatmap_%s.pdf", line)))
  
  if(save_images) pheatmap(
      d, annotation_col = line_annotation,
      color = hm_colorscale, annotation_colors = line_color, 
      show_rownames = TRUE, show_colnames = FALSE, 
      cluster_rows = hc, cluster_cols = hc,
      main = sprintf("Angles Between Profile Vectors for %s", line),
      border_color = NA, cellheight = 8, cellwidth = 8, height = 30, 
      width = 30, filename = file.path(img_out_dir, sprintf(
        "EffectVectorHeatmap_supersize_%s.pdf", line)))
}
```

# Enrichment Heatmap
I look at enrichment heatmaps, i.e. which cell lines have an enrichment in which pathways / targets.

## Log-Odds Heatmap
I create a heatmap of the enrichment (log odds ratio) to determine which pathways and targets are enriched in each cell line
```{r}
heatmap_pathways = oddsratio_pathway[, c("Line", "Label", "OddsRatio")]
heatmap_pathways = acast(
  data = heatmap_pathways, 
  formula = Line ~ Label, value.var = "OddsRatio", 
  fun.aggregate = max, fill = 0)
# Replace Inf with the finite maximum
heatmap_pathways[is.infinite(heatmap_pathways)] = max(
  heatmap_pathways[!is.infinite(heatmap_pathways)])
heatmap_pathways[heatmap_pathways != 0] = log2(
  heatmap_pathways[heatmap_pathways != 0])
hc_pathways = as.dist((1 - cor(heatmap_pathways)) / 2)
hc_pathways_line = as.dist((1 - cor(t(heatmap_pathways))) / 2)

heatmap_targets = oddsratio_target[, c("Line", "Label", "OddsRatio")]
heatmap_targets = acast(
  data = heatmap_targets, 
  formula = Line ~ Label, value.var = "OddsRatio", 
  fun.aggregate = max, fill = 0)
# Replace Inf with the finite maximum
heatmap_targets[is.infinite(heatmap_targets)] = max(
  heatmap_targets[!is.infinite(heatmap_targets)])
heatmap_targets[heatmap_targets != 0] = log2(
  heatmap_targets[heatmap_targets != 0])
hc_targets = as.dist((1 - cor(heatmap_targets)) / 2)
hc_targets_line = as.dist((1 - cor(t(heatmap_targets))) / 2)

# hm_colorscale = colorRampPalette(
#   c('#b2182b','#d6604d','#f4a582', '#f7f7f7','#f7f7f7', '#f7f7f7',
#     '#f7f7f7', '#f7f7f7', '#f7f7f7'))(150)

hm_breaks = seq(0, max(heatmap_pathways, na.rm = TRUE), length.out = 50)
hm_colorscale = colorRampPalette(c("#f7f7f7", "#4575B4"))(length(hm_breaks))
pheatmap(
  heatmap_pathways, cluster_rows = hc_pathways_line, 
  cluster_cols = hc_pathways, 
  breaks = hm_breaks, color = hm_colorscale, 
  cellwidth = 10, cellheight = 10)
if(save_images) {
  pheatmap(
    heatmap_pathways, cluster_rows = hc_pathways_line, 
    cluster_cols = hc_pathways,
    breaks = hm_breaks, color = hm_colorscale, 
    cellwidth = 10, cellheight = 10, 
    filename = file.path(img_out_dir, "Heatmap_LogOdds_Pathways.pdf"))
}

# Edits for Manuscript
# heatmap_targets[is.na(heatmap_targets)] = 0
# old_names = c(
#   "gsk-3", "hdac", "aurora kinase", "mek", "c-met", "jak", "fak", "cdk", "erk", 
#   "igf-1r", "fgfr", "flt", "egfr", "alk", "c-kit", "chk", "plk", "pi3k", "akt", 
#   "vegfr", "src", "bcr-abl", "syk", "atm/atr", "pkc", "mtor", "pdgfr")
# heatmap_targets = heatmap_targets[, colnames(heatmap_targets) %in% old_names]
# heatmap_targets = cbind(heatmap_targets, "vegfr" = 0)
# heatmap_targets["D004T01", "vegfr"] = 4.5

hm_breaks = seq(0, max(heatmap_targets, na.rm = TRUE), length.out = 50)
hm_colorscale = colorRampPalette(c("#f7f7f7", "#4575B4"))(length(hm_breaks))
pheatmap(
  heatmap_targets, cluster_rows = hc_targets_line, 
  cluster_cols = hc_targets,
  breaks = hm_breaks, color = hm_colorscale, 
  cellwidth = 10, cellheight = 10)
if(save_images) {
  pheatmap(
    heatmap_targets, cluster_rows = hc_targets_line, 
    cluster_cols = hc_targets,
    breaks = hm_breaks, color = hm_colorscale, 
    cellwidth = 10, cellheight = 10, 
    filename = file.path(img_out_dir, "Heatmap_LogOdds_Targets.pdf"))
}
```

## Binary Heatmap
```{r}
binary_heatmap_pathways = heatmap_pathways
binary_heatmap_pathways[binary_heatmap_pathways > 0] = 1
binary_heatmap_targets = heatmap_targets
binary_heatmap_targets[binary_heatmap_targets > 0] = 1

hm_colorscale = colorRampPalette(c("#f7f7f7", "#4575B4"))(2)
pheatmap(
  binary_heatmap_pathways, cluster_rows = hc_pathways_line, 
  cluster_cols = hc_pathways, 
  color = hm_colorscale, legend = FALSE,
  cellwidth = 10, cellheight = 10)
pheatmap(
  binary_heatmap_targets, cluster_rows = hc_targets_line, 
  cluster_cols = hc_targets,
  color = hm_colorscale, legend = FALSE,
  cellwidth = 10, cellheight = 10)

if(save_images) {
  pheatmap(
    binary_heatmap_pathways, cluster_rows = hc_pathways_line, 
    cluster_cols = hc_pathways,
    color = hm_colorscale, legend = FALSE,
    cellwidth = 10, cellheight = 10, 
    filename = file.path(img_out_dir, "Heatmap_Binary_Pathways.pdf"))
  pheatmap(
    binary_heatmap_targets, cluster_rows = hc_targets_line, 
    cluster_cols = hc_targets,
    color = hm_colorscale, legend = FALSE,
    cellwidth = 10, cellheight = 10,
    filename = file.path(img_out_dir, "Heatmap_Binary_Targets.pdf"))
}
```

# Find Positive Controls
Based on the results of the human screen, image phenotypes describe drug modes of action, i.e. lethal drugs should be similar to Bortezomib
```{r}
# Get angles of all drugs to Bortezomib to each line
similar_drugs = list()
for(line in lines) {
  line_profiles = profiles_active[metadata_active$Line == line, ]
  line_metadata = metadata_active[metadata_active$Line == line, ]
  angles = acos(get_angles(line_profiles)) * 180 / pi
  angles_Bortezomib = angles[line_metadata$Drug == "Bortezomib (PS-341)", ]
  similar_drugs[[line]] = sort(angles_Bortezomib)
}

# Find the number of common drugs with angles below a certain threshold
thresh = 40
common_drugs = Reduce(intersect, lapply(
  similar_drugs, function(x) substr(names(which(x < thresh)), 9, 100)))
# Get angles of common drugs for each line
common_drugs_list = list()
for(drug in common_drugs) {
  common_drugs_list[[drug]] = c()
  for(line in lines) {
    common_drugs_list[[drug]][line] = similar_drugs[[line]][
      paste0(line, ".", drug)]
  }
}
common_drugs_list = do.call(rbind, common_drugs_list)
print(common_drugs_list)
```

